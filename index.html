<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Co√ªt de revient & Suivi des marges - The Gut Cleanser</title>
    <!-- Librairies pour export/import Excel et g√©n√©ration PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- EmailJS pour l'envoi d'emails -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Styles pour la page de connexion */
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 40px;
            text-align: center;
        }
        
        .login-header {
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .login-header p {
            color: #6c757d;
            font-size: 1.1em;
        }
        
        .login-form {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-login {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: transform 0.2s;
        }
        
        .btn-login:hover {
            transform: translateY(-2px);
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }
        
        /* Header avec info utilisateur */
        .user-header {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .user-details h4 {
            margin: 0;
            font-size: 1.1em;
        }
        
        .user-details p {
            margin: 0;
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .logout-btn {
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .logout-btn:hover {
            background: rgba(220, 53, 69, 1);
        }
        
        /* Restrictions visuelles pour les clients */
        .admin-only {
            position: relative;
        }
        
        .admin-only.restricted {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .admin-only.restricted::after {
            content: "üîí Acc√®s administrateur requis";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }
        
        /* Styles existants inchang√©s */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 30px;
            padding: 5px;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .cost-summary {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            margin-top: 30px;
        }
        
        .cost-summary h3 {
            font-size: 1.8em;
            margin-bottom: 15px;
        }
        
        .cost-summary .amount {
            font-size: 2.5em;
            font-weight: bold;
        }
        
        .level-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            text-align: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            line-height: 20px;
        }
        
        .level-0 { background: #e74c3c; }
        .level-1 { background: #f39c12; }
        .level-2 { background: #27ae60; }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-left: 5px solid #17a2b8;
            color: #0c5460;
        }
        
        .import-export {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #28a745;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
            display: inline-block;
        }
        
        .file-input-label:hover {
            transform: translateY(-2px);
        }
        
        .btn-export {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
        }
        
        .btn-template {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }
        
        /* Onglet Admin */
        .admin-panel {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-left: 5px solid #a71e2a;
        }
        
        .admin-panel h3 {
            color: white;
        }
        
        .user-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            color: #2c3e50;
            border-left: 4px solid #667eea;
        }
        
        .user-card.admin {
            border-left-color: #dc3545;
        }
        
        .user-role {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .role-admin {
            background: #dc3545;
            color: white;
        }
        
        .role-client {
            background: #17a2b8;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Page de connexion -->
    <div id="login-page" class="login-container">
        <div class="login-header">
            <h1>üí∞ Connexion</h1>
            <p>Co√ªt de revient & Suivi des marges</p>
        </div>
        
        <form class="login-form" onsubmit="return login(event)">
            <div class="form-group">
                <label for="username">Nom d'utilisateur</label>
                <input type="text" id="username" required>
            </div>
            
            <div class="form-group">
                <label for="password">Mot de passe</label>
                <input type="password" id="password" required>
            </div>
            
            <button type="submit" class="btn-login">Se connecter</button>
        </form>
        
        <div id="login-error" class="error-message"></div>
    </div>

    <!-- Application principale -->
    <div id="main-app" style="display: none;">
        <div class="user-header">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">A</div>
                <div class="user-details">
                    <h4 id="user-name">Nom d'utilisateur</h4>
                    <p id="user-role">R√¥le utilisateur</p>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">üö™ D√©connexion</button>
        </div>
        
        <div class="container">
            <div class="header">
                <h1>üí∞ Co√ªt de revient & Suivi des marges</h1>
                <p>The Gut Cleanser - Cure d√©tox naturelle antiparasitaire</p>
            </div>
            
            <div class="main-content">
                <div class="tabs">
                    <div class="tab active" onclick="showTab('produit')">üì¶ Produit Final</div>
                    <div class="tab" onclick="showTab('matieres')">üß™ Mati√®res Premi√®res</div>
                    <div class="tab" onclick="showTab('fabrication')">‚öôÔ∏è Fabrication</div>
                    <div class="tab" onclick="showTab('nomenclature')">üìã Nomenclature</div>
                    <div class="tab" onclick="showTab('couts')">üí∞ Co√ªts</div>
                    <div class="tab admin-only" id="admin-tab" onclick="showTab('admin')">üîß Administration</div>
                </div>
                
                <!-- Onglet Produit Final -->
                <div id="produit" class="tab-content active">
                    <div class="section">
                        <h3>üéØ Informations Produit</h3>
                        <div class="form-row">
                            <div>
                                <label>Nom du produit</label>
                                <input type="text" id="produit_nom" value="Cure d√©tox naturelle antiparasitaire" onchange="updateProduit()">
                            </div>
                            <div>
                                <label>Prix de vente (‚Ç¨)</label>
                                <input type="number" id="produit_prix" value="99.90" step="0.01" onchange="updateProduit()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Quantit√© par cure</label>
                                <input type="number" id="produit_quantite" value="1" onchange="updateProduit()">
                            </div>
                            <div>
                                <label>Unit√©</label>
                                <select id="produit_unite" onchange="updateProduit()">
                                    <option value="cure">Cure compl√®te</option>
                                    <option value="flacon">Flacon</option>
                                    <option value="sachet">Sachet</option>
                                    <option value="g√©lule">G√©lule</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="produit_description" rows="3" onchange="updateProduit()">Cure d√©tox 3-en-1 100% naturelle pour purifier le corps et retrouver de l'√©nergie</textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Onglet Mati√®res Premi√®res -->
                <div id="matieres" class="tab-content">
                    <div class="import-export admin-only">
                        <h3>üìä Import / Export des Donn√©es</h3>
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div class="file-input-wrapper">
                                <input type="file" id="import-excel" accept=".xlsx,.xls,.csv" onchange="importerExcel(event)">
                                <label for="import-excel" class="file-input-label">üì• Importer Excel</label>
                            </div>
                            <button class="btn btn-export" onclick="exporterExcel()">üì§ Exporter Excel</button>
                            <button class="btn btn-template" onclick="telechargerTemplate()">üìã Template Import</button>
                            <button class="btn" onclick="sauvegarderDonnees()">üíæ Sauvegarder</button>
                            <button class="btn" onclick="chargerDonnees()">üìÇ Charger</button>
                        </div>
                        <div id="import-status" style="margin-top: 15px;"></div>
                    </div>
                    
                    <div class="section admin-only">
                        <h3>üß™ Gestion des Mati√®res Premi√®res</h3>
                        <div class="alert alert-info">
                            <strong>üí° Conseil :</strong> Ajoutez tous les ingr√©dients, emballages et mat√©riaux n√©cessaires √† la fabrication.
                        </div>
                        
                        <div class="form-row">
                            <div>
                                <label>R√©f√©rence article</label>
                                <input type="text" id="matiere_reference" placeholder="Ex: MP-001">
                            </div>
                            <div>
                                <label>D√©signation article</label>
                                <input type="text" id="matiere_nom" placeholder="Ex: Extrait d'ail noir">
                            </div>
                            <div>
                                <label>Cat√©gorie</label>
                                <select id="matiere_categorie">
                                    <option value="ingredient_actif">Ingr√©dient actif</option>
                                    <option value="excipient">Excipient</option>
                                    <option value="emballage_primaire">Emballage primaire</option>
                                    <option value="emballage_secondaire">Emballage secondaire</option>
                                    <option value="etiquetage">√âtiquetage</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Prix unitaire (‚Ç¨)</label>
                                <input type="number" id="matiere_prix" step="0.001" placeholder="0.000">
                            </div>
                            <div>
                                <label>Unit√© d'achat</label>
                                <select id="matiere_unite">
                                    <option value="kg">Kilogramme (kg)</option>
                                    <option value="g">Gramme (g)</option>
                                    <option value="l">Litre (l)</option>
                                    <option value="ml">Millilitre (ml)</option>
                                    <option value="piece">Pi√®ce</option>
                                    <option value="m">M√®tre</option>
                                    <option value="m2">M√®tre carr√©</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Fournisseur</label>
                                <input type="text" id="matiere_fournisseur" placeholder="Nom du fournisseur">
                            </div>
                            <div>
                                <label>Centre de co√ªt</label>
                                <select id="matiere_centre_cout">
                                    <option value="production">Production</option>
                                    <option value="emballage">Emballage</option>
                                    <option value="conditionnement">Conditionnement</option>
                                    <option value="qualite">Qualit√©</option>
                                    <option value="logistique">Logistique</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Famille produit</label>
                                <select id="matiere_famille">
                                    <option value="ingredients">Ingr√©dients</option>
                                    <option value="emballages">Emballages</option>
                                    <option value="accessoires">Accessoires</option>
                                    <option value="etiquettes">√âtiquettes</option>
                                    <option value="consommables">Consommables</option>
                                </select>
                            </div>
                            <div>
                                <label>Origine g√©ographique</label>
                                <select id="matiere_origine">
                                    <option value="france">France</option>
                                    <option value="europe">Europe</option>
                                    <option value="asie">Asie</option>
                                    <option value="amerique">Am√©rique</option>
                                    <option value="afrique">Afrique</option>
                                    <option value="oceanie">Oc√©anie</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Stock minimum</label>
                                <input type="number" id="matiere_stock_min" step="0.1" placeholder="Quantit√© minimum">
                            </div>
                            <div>
                                <label>D√©lai approvisionnement (jours)</label>
                                <input type="number" id="matiere_delai" step="1" placeholder="Ex: 15">
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="ajouterMatiere()">‚ûï Ajouter la mati√®re premi√®re</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üì¶ Liste des Mati√®res Premi√®res</h3>
                        <table id="table_matieres">
                            <thead>
                                <tr>
                                    <th>R√©f√©rence</th>
                                    <th>D√©signation article</th>
                                    <th>Cat√©gorie</th>
                                    <th>Prix unitaire</th>
                                    <th>Unit√©</th>
                                    <th>Centre de co√ªt</th>
                                    <th>Famille</th>
                                    <th>Origine</th>
                                    <th>Fournisseur</th>
                                    <th class="admin-only">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_matieres">
                                <!-- Les mati√®res seront ajout√©es ici -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Onglet Fabrication -->
                <div id="fabrication" class="tab-content">
                    <div class="section admin-only">
                        <h3>‚öôÔ∏è √âtapes de Fabrication</h3>
                        <div class="alert alert-info">
                            <strong>üí° Conseil :</strong> D√©finissez chaque √©tape avec ses co√ªts (main d'≈ìuvre, machines, √©nergie...).
                        </div>
                        
                        <div class="form-row">
                            <div>
                                <label>Nom de l'√©tape</label>
                                <input type="text" id="etape_nom" placeholder="Ex: M√©lange des ingr√©dients">
                            </div>
                            <div>
                                <label>Dur√©e (minutes)</label>
                                <input type="number" id="etape_duree" step="1" placeholder="Dur√©e en minutes">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Co√ªt horaire main d'≈ìuvre (‚Ç¨/h)</label>
                                <input type="number" id="etape_cout_mo" step="0.01" placeholder="25.00">
                            </div>
                            <div>
                                <label>Co√ªt machine/√©nergie (‚Ç¨)</label>
                                <input type="number" id="etape_cout_machine" step="0.01" placeholder="0.50">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Type d'√©tape</label>
                                <select id="etape_type">
                                    <option value="preparation">Pr√©paration</option>
                                    <option value="melange">M√©lange</option>
                                    <option value="conditionnement">Conditionnement</option>
                                    <option value="controle">Contr√¥le qualit√©</option>
                                    <option value="emballage">Emballage</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                            <div>
                                <label>Ordre d'ex√©cution</label>
                                <input type="number" id="etape_ordre" step="1" placeholder="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description d√©taill√©e</label>
                            <textarea id="etape_description" rows="3" placeholder="D√©crivez pr√©cis√©ment cette √©tape de fabrication..."></textarea>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="ajouterEtape()">‚ûï Ajouter l'√©tape</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üîÑ Process de Fabrication</h3>
                        <table id="table_etapes">
                            <thead>
                                <tr>
                                    <th>Ordre</th>
                                    <th>√âtape</th>
                                    <th>Type</th>
                                    <th>Dur√©e</th>
                                    <th>Co√ªt M.O.</th>
                                    <th>Co√ªt Machine</th>
                                    <th>Co√ªt Total</th>
                                    <th class="admin-only">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_etapes">
                                <!-- Les √©tapes seront ajout√©es ici -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Onglet Nomenclature -->
                <div id="nomenclature" class="tab-content">
                    <div class="section admin-only">
                        <h3>üìã Composition du Produit</h3>
                        <div class="alert alert-info">
                            <strong>üí° Conseil :</strong> D√©finissez la quantit√© exacte de chaque mati√®re premi√®re n√©cessaire pour 1 unit√© de produit fini.
                        </div>
                        
                        <div class="form-row">
                            <div>
                                <label>Mati√®re premi√®re</label>
                                <select id="nomenclature_matiere">
                                    <option value="">S√©lectionnez une mati√®re premi√®re</option>
                                    <!-- Options remplies dynamiquement -->
                                </select>
                            </div>
                            <div>
                                <label>Quantit√© n√©cessaire</label>
                                <input type="number" id="nomenclature_quantite" step="0.001" placeholder="Quantit√©">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Unit√© de consommation</label>
                                <select id="nomenclature_unite">
                                    <option value="kg">Kilogramme (kg)</option>
                                    <option value="g">Gramme (g)</option>
                                    <option value="l">Litre (l)</option>
                                    <option value="ml">Millilitre (ml)</option>
                                    <option value="piece">Pi√®ce</option>
                                    <option value="m">M√®tre</option>
                                    <option value="m2">M√®tre carr√©</option>
                                </select>
                            </div>
                            <div>
                                <label>Niveau hi√©rarchique</label>
                                <select id="nomenclature_niveau">
                                    <option value="0">Niveau 0 - Produit fini</option>
                                    <option value="1">Niveau 1 - Composant principal</option>
                                    <option value="2">Niveau 2 - Mati√®re premi√®re</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="ajouterNomenclature()">‚ûï Ajouter √† la nomenclature</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üèóÔ∏è Structure de la Nomenclature</h3>
                        <table id="table_nomenclature">
                            <thead>
                                <tr>
                                    <th>Niveau</th>
                                    <th>R√©f√©rence</th>
                                    <th>D√©signation article</th>
                                    <th>Quantit√©</th>
                                    <th>Unit√©</th>
                                    <th>Prix unitaire</th>
                                    <th>Centre de co√ªt</th>
                                    <th>Famille</th>
                                    <th>Co√ªt total</th>
                                    <th class="admin-only">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_nomenclature">
                                <!-- La nomenclature sera affich√©e ici -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Onglet Co√ªts -->
                <div id="couts" class="tab-content">
                    <div class="section">
                        <h3>üí∞ Analyse des Co√ªts de Revient</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div class="cost-summary" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                                <h3>Mati√®res Premi√®res</h3>
                                <div class="amount" id="cout_matieres">0.00 ‚Ç¨</div>
                            </div>
                            
                            <div class="cost-summary" style="background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);">
                                <h3>Main d'≈íuvre</h3>
                                <div class="amount" id="cout_main_oeuvre">0.00 ‚Ç¨</div>
                            </div>
                            
                            <div class="cost-summary" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                                <h3>Frais de Fabrication</h3>
                                <div class="amount" id="cout_fabrication">0.00 ‚Ç¨</div>
                            </div>
                            
                            <div class="cost-summary">
                                <h3>CO√õT DE REVIENT TOTAL</h3>
                                <div class="amount" id="cout_total">0.00 ‚Ç¨</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div class="cost-summary" style="background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);">
                                <h3>Prix de Vente</h3>
                                <div class="amount" id="prix_vente_display">99.90 ‚Ç¨</div>
                            </div>
                            
                            <div class="cost-summary" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                                <h3>Marge Brute</h3>
                                <div class="amount" id="marge_brute">0.00 ‚Ç¨</div>
                            </div>
                            
                            <div class="cost-summary" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">
                                <h3>Taux de Marge</h3>
                                <div class="amount" id="taux_marge">0.0%</div>
                            </div>
                            
                            <div class="cost-summary" style="background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);">
                                <h3>Coefficient Multiplicateur</h3>
                                <div class="amount" id="coefficient">0.0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üìä R√©partition des Co√ªts</h3>
                        <table id="table_repartition">
                            <thead>
                                <tr>
                                    <th>Poste de co√ªt</th>
                                    <th>Montant (‚Ç¨)</th>
                                    <th>Pourcentage</th>
                                    <th>D√©tail</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_repartition">
                                <!-- La r√©partition sera calcul√©e automatiquement -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); text-align: center;">
                        <h3>üìÑ G√©n√©rer la Synth√®se PDF</h3>
                        <p style="margin-bottom: 20px; color: #6c757d;">Cr√©ez un rapport professionnel avec tous les indicateurs de co√ªt</p>
                        <button class="btn" onclick="genererPDF()" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); font-size: 1.1em; padding: 15px 30px;">üìã G√©n√©rer le Rapport PDF</button>
                    </div>
                </div>
                
                <!-- Onglet Administration -->
                <div id="admin" class="tab-content">
                    <div class="section admin-panel">
                        <h3>üîß Panel d'Administration</h3>
                        <p style="margin-bottom: 20px;">Gestion des utilisateurs et param√®tres syst√®me</p>
                    </div>
                    
                    <div class="section">
                        <h3>üë• Cr√©er un nouvel utilisateur</h3>
                        <div class="form-row">
                            <div>
                                <label>Nom complet</label>
                                <input type="text" id="new_user_name" placeholder="Ex: Jean Dupont">
                            </div>
                            <div>
                                <label>Email</label>
                                <input type="email" id="new_user_email" placeholder="jean.dupont@client.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Entreprise</label>
                                <input type="text" id="new_user_company" placeholder="Nom de l'entreprise">
                            </div>
                            <div>
                                <label>R√¥le</label>
                                <select id="new_user_role">
                                    <option value="client">Client</option>
                                    <option value="admin">Administrateur</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="creerUtilisateur()">‚ûï Cr√©er l'utilisateur</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üìã Liste des utilisateurs</h3>
                        <div id="users-list">
                            <!-- Les utilisateurs seront affich√©s ici -->
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üìß Configuration Email</h3>
                        <div class="alert alert-info">
                            <strong>üí° Pour activer l'envoi automatique d'emails :</strong><br>
                            1. Cr√©ez un compte sur <a href="https://emailjs.com" target="_blank">EmailJS.com</a><br>
                            2. Configurez un service email (Gmail, Outlook, etc.)<br>
                            3. Cr√©ez un template avec les variables: to_email, to_name, user_name, user_password, login_url<br>
                            4. Saisissez vos cl√©s ci-dessous
                        </div>
                        
                        <div class="form-row">
                            <div>
                                <label>Service ID</label>
                                <input type="text" id="email_service_id" placeholder="Ex: service_viconseil" value="service_viconseil">
                            </div>
                            <div>
                                <label>Template ID</label>
                                <input type="text" id="email_template_id" placeholder="Ex: template_user_credentials" value="template_user_credentials">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Public Key</label>
                                <input type="text" id="email_public_key" placeholder="Ex: your_public_key_here" value="your_public_key_here">
                            </div>
                            <div>
                                <label>Email de r√©ponse</label>
                                <input type="email" id="email_reply_to" placeholder="contact@viconseil.com" value="contact@viconseil.com">
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="updateEmailConfig()">üìß Mettre √† jour la config email</button>
                            <button class="btn" onclick="testEmail()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">üß™ Tester l'envoi</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üîë Modifier mes identifiants admin</h3>
                        <div class="form-row">
                            <div>
                                <label>Nouveau nom d'utilisateur</label>
                                <input type="text" id="admin_new_username" placeholder="Actuel: viconseil">
                            </div>
                            <div>
                                <label>Nouveau mot de passe</label>
                                <input type="password" id="admin_new_password" placeholder="Actuel: mdpadmin">
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="modifierAdminCredentials()">üîÑ Mettre √† jour</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration EmailJS (√† remplacer par vos vraies cl√©s)
        const EMAIL_CONFIG = {
            serviceId: 'service_viconseil',
            templateId: 'template_user_credentials',
            publicKey: 'your_public_key_here'
        };

        // Initialiser EmailJS
        function initEmailJS() {
            if (typeof emailjs !== 'undefined') {
                emailjs.init(EMAIL_CONFIG.publicKey);
            }
        }

        // Fonction d'envoi d'email r√©el
        function envoyerEmailReel(email, name, username, password, emailContent) {
            return new Promise((resolve, reject) => {
                if (typeof emailjs === 'undefined') {
                    reject(new Error('EmailJS not loaded'));
                    return;
                }

                const templateParams = {
                    to_email: email,
                    to_name: name,
                    user_name: username,
                    user_password: password,
                    login_url: window.location.href,
                    message: emailContent,
                    from_name: 'VI Conseil',
                    reply_to: 'contact@viconseil.com'
                };

                emailjs.send(EMAIL_CONFIG.serviceId, EMAIL_CONFIG.templateId, templateParams)
                    .then((response) => {
                        console.log('Email envoy√© avec succ√®s:', response);
                        resolve(response);
                    })
                    .catch((error) => {
                        console.error('Erreur envoi email:', error);
                        reject(error);
                    });
            });
        }

        // Syst√®me d'authentification et gestion des utilisateurs
        let currentUser = null;
        let users = [
            {
                id: 1,
                username: 'viconseil',
                password: 'mdpadmin',
                name: 'Vincent - VI Conseil',
                email: 'vincent@viconseil.com',
                role: 'admin',
                company: 'VI Conseil'
            }
        ];

        // Variables globales pour les donn√©es (inchang√©es)
        let matieresPremiere = [];
        let etapesFabrication = [];
        let nomenclatureItems = [];
        let produitInfo = {
            nom: "Cure d√©tox naturelle antiparasitaire",
            prix: 99.90,
            quantite: 1,
            unite: "cure",
            description: "Cure d√©tox 3-en-1 100% naturelle pour purifier le corps et retrouver de l'√©nergie"
        };

        // Fonctions d'authentification
        function login(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(user));
                showMainApp();
            } else {
                errorDiv.textContent = 'Nom d\'utilisateur ou mot de passe incorrect';
                errorDiv.style.display = 'block';
            }
            
            return false;
        }

        function logout() {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-page').style.display = 'block';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showMainApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            // Mettre √† jour l'interface utilisateur
            document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Administrateur' : 'Client';
            
            // Appliquer les restrictions selon le r√¥le
            applyRoleRestrictions();
            
            // Charger les donn√©es si c'est un admin
            if (currentUser.role === 'admin') {
                chargerUtilisateurs();
            }
        }

        function applyRoleRestrictions() {
            const adminElements = document.querySelectorAll('.admin-only');
            
            if (currentUser.role !== 'admin') {
                adminElements.forEach(element => {
                    element.classList.add('restricted');
                });
                // Masquer l'onglet admin pour les clients
                document.getElementById('admin-tab').style.display = 'none';
            } else {
                adminElements.forEach(element => {
                    element.classList.remove('restricted');
                });
                document.getElementById('admin-tab').style.display = 'block';
            }
        }

        // Fonctions de gestion des utilisateurs (Admin seulement)
        function creerUtilisateur() {
            if (currentUser.role !== 'admin') return;
            
            const name = document.getElementById('new_user_name').value;
            const email = document.getElementById('new_user_email').value;
            const company = document.getElementById('new_user_company').value;
            const role = document.getElementById('new_user_role').value;
            
            if (!name || !email) {
                alert('Veuillez remplir le nom et l\'email');
                return;
            }
            
            // G√©n√©rer identifiants automatiques
            const username = email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');
            const password = generatePassword();
            
            const newUser = {
                id: users.length + 1,
                username: username,
                password: password,
                name: name,
                email: email,
                role: role,
                company: company
            };
            
            users.push(newUser);
            
            // Envoi d'email r√©el via EmailJS
            const emailContent = `
Bonjour ${name},

Voici vos identifiants pour acc√©der √† l'outil "Co√ªt de revient & Suivi des marges" :

URL : ${window.location.href}
Nom d'utilisateur : ${username}
Mot de passe : ${password}

Cordialement,
VI Conseil
            `;
            
            // Tenter l'envoi d'email r√©el
            envoyerEmailReel(email, name, username, password, emailContent)
                .then(() => {
                    alert(`Utilisateur cr√©√© avec succ√®s !
                    
Identifiants g√©n√©r√©s :
- Nom d'utilisateur : ${username}
- Mot de passe : ${password}

‚úÖ Un email a √©t√© envoy√© √† ${email} avec ces informations.`);
                })
                .catch((error) => {
                    console.error('Erreur envoi email:', error);
                    
                    // Fallback : afficher les infos et permettre copie
                    const emailWindow = window.open('', '_blank', 'width=600,height=500');
                    emailWindow.document.write(`
                        <html>
                        <head><title>Identifiants Client - √Ä envoyer manuellement</title></head>
                        <body style="font-family: Arial, sans-serif; padding: 20px;">
                            <h2>‚ö†Ô∏è Email automatique non envoy√©</h2>
                            <p><strong>Utilisateur cr√©√© :</strong> ${name}</p>
                            <p><strong>Email :</strong> ${email}</p>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h3>üìß Contenu √† envoyer manuellement :</h3>
                                <textarea style="width: 100%; height: 200px; font-family: monospace;">${emailContent}</textarea>
                            </div>
                            
                            <button onclick="navigator.clipboard.writeText(document.querySelector('textarea').value).then(() => alert('Contenu copi√© !'))" 
                                    style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                                üìã Copier le contenu
                            </button>
                            
                            <p style="color: #666; margin-top: 20px;">
                                <small>Veuillez copier ce contenu et l'envoyer manuellement √† ${email}</small>
                            </p>
                        </body>
                        </html>
                    `);
                    
                    alert(`Utilisateur cr√©√© avec succ√®s !
                    
Identifiants g√©n√©r√©s :
- Nom d'utilisateur : ${username}
- Mot de passe : ${password}

‚ö†Ô∏è L'email automatique n'a pas pu √™tre envoy√©.
Une fen√™tre s'est ouverte avec le contenu √† envoyer manuellement √† ${email}.`);
                });
            
            // Vider le formulaire
            document.getElementById('new_user_name').value = '';
            document.getElementById('new_user_email').value = '';
            document.getElementById('new_user_company').value = '';
            
            chargerUtilisateurs();
        }

        function generatePassword() {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        function chargerUtilisateurs() {
            if (currentUser.role !== 'admin') return;
            
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            
            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = `user-card ${user.role}`;
                userCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${user.name} <span class="user-role role-${user.role}">${user.role.toUpperCase()}</span></h4>
                            <p><strong>Email:</strong> ${user.email}</p>
                            <p><strong>Entreprise:</strong> ${user.company}</p>
                            <p><strong>Identifiants:</strong> ${user.username} / ${user.password}</p>
                        </div>
                        <div>
                            ${user.role !== 'admin' ? `<button class="btn btn-danger" onclick="supprimerUtilisateur(${user.id})">üóëÔ∏è Supprimer</button>` : ''}
                        </div>
                    </div>
                `;
                usersList.appendChild(userCard);
            });
        }

        function supprimerUtilisateur(userId) {
            if (currentUser.role !== 'admin') return;
            
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur ?')) {
                users = users.filter(u => u.id !== userId);
                chargerUtilisateurs();
            }
        }

        function updateEmailConfig() {
            if (currentUser.role !== 'admin') return;
            
            EMAIL_CONFIG.serviceId = document.getElementById('email_service_id').value;
            EMAIL_CONFIG.templateId = document.getElementById('email_template_id').value;
            EMAIL_CONFIG.publicKey = document.getElementById('email_public_key').value;
            
            // R√©initialiser EmailJS avec la nouvelle cl√©
            if (typeof emailjs !== 'undefined' && EMAIL_CONFIG.publicKey !== 'your_public_key_here') {
                emailjs.init(EMAIL_CONFIG.publicKey);
            }
            
            // Sauvegarder dans le localStorage
            localStorage.setItem('emailConfig', JSON.stringify(EMAIL_CONFIG));
            
            alert('Configuration email mise √† jour avec succ√®s !');
        }

        function testEmail() {
            if (currentUser.role !== 'admin') return;
            
            const testEmail = prompt('Entrez une adresse email pour tester l\'envoi :');
            if (!testEmail) return;
            
            const emailContent = `
Ceci est un email de test depuis l'outil "Co√ªt de revient & Suivi des marges".

Si vous recevez cet email, la configuration est correcte !

Cordialement,
VI Conseil
            `;
            
            envoyerEmailReel(testEmail, 'Test', 'test_user', 'test_password', emailContent)
                .then(() => {
                    alert('‚úÖ Email de test envoy√© avec succ√®s √† ' + testEmail);
                })
                .catch((error) => {
                    alert('‚ùå Erreur lors de l\'envoi de l\'email de test : ' + error.message);
                });
        }

        function modifierAdminCredentials() {
            if (currentUser.role !== 'admin') return;
            
            const newUsername = document.getElementById('admin_new_username').value;
            const newPassword = document.getElementById('admin_new_password').value;
            
            if (!newUsername && !newPassword) {
                alert('Veuillez saisir au moins un nouveau param√®tre');
                return;
            }
            
            const adminUser = users.find(u => u.id === currentUser.id);
            
            if (newUsername) {
                adminUser.username = newUsername;
                currentUser.username = newUsername;
            }
            
            if (newPassword) {
                adminUser.password = newPassword;
                currentUser.password = newPassword;
            }
            
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            alert('Identifiants administrateur mis √† jour avec succ√®s !');
            
            document.getElementById('admin_new_username').value = '';
            document.getElementById('admin_new_password').value = '';
        }

        // V√©rification de session au chargement
        function checkSession() {
            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showMainApp();
                return true;
            }
            return false;
        }

        // Toutes les autres fonctions existantes (inchang√©es)
        function showTab(tabName) {
            // V√©rifier les droits d'acc√®s
            if (tabName === 'admin' && currentUser.role !== 'admin') {
                alert('Acc√®s r√©serv√© aux administrateurs');
                return;
            }
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'nomenclature') {
                updateMatieresSelect();
            }
            if (tabName === 'couts') {
                calculerCouts();
            }
            if (tabName === 'admin') {
                chargerUtilisateurs();
            }
        }

        function updateProduit() {
            if (currentUser.role !== 'admin') return;
            
            produitInfo.nom = document.getElementById('produit_nom').value;
            produitInfo.prix = parseFloat(document.getElementById('produit_prix').value) || 0;
            produitInfo.quantite = parseFloat(document.getElementById('produit_quantite').value) || 1;
            produitInfo.unite = document.getElementById('produit_unite').value;
            produitInfo.description = document.getElementById('produit_description').value;
            
            document.getElementById('prix_vente_display').textContent = produitInfo.prix.toFixed(2) + ' ‚Ç¨';
            calculerCouts();
        }

        function ajouterMatiere() {
            if (currentUser.role !== 'admin') return;
            
            const reference = document.getElementById('matiere_reference').value;
            const nom = document.getElementById('matiere_nom').value;
            const categorie = document.getElementById('matiere_categorie').value;
            const prix = parseFloat(document.getElementById('matiere_prix').value);
            const unite = document.getElementById('matiere_unite').value;
            const fournisseur = document.getElementById('matiere_fournisseur').value;
            const centreCout = document.getElementById('matiere_centre_cout').value;
            const famille = document.getElementById('matiere_famille').value;
            const origine = document.getElementById('matiere_origine').value;
            const stockMin = parseFloat(document.getElementById('matiere_stock_min').value) || 0;
            const delai = parseInt(document.getElementById('matiere_delai').value) || 0;

            if (!reference || !nom || !prix) {
                alert('Veuillez remplir au minimum la r√©f√©rence, le nom et le prix de la mati√®re premi√®re.');
                return;
            }

            if (matieresPremiere.find(m => m.reference === reference)) {
                alert('Cette r√©f√©rence existe d√©j√†. Veuillez utiliser une r√©f√©rence unique.');
                return;
            }

            const matiere = {
                id: Date.now(),
                reference: reference,
                nom: nom,
                categorie: categorie,
                prix: prix,
                unite: unite,
                fournisseur: fournisseur,
                centreCout: centreCout,
                famille: famille,
                origine: origine,
                stockMin: stockMin,
                delai: delai
            };

            matieresPremiere.push(matiere);
            afficherMatieres();
            clearMatiereForm();
            updateMatieresSelect();
        }

        function clearMatiereForm() {
            document.getElementById('matiere_reference').value = '';
            document.getElementById('matiere_nom').value = '';
            document.getElementById('matiere_prix').value = '';
            document.getElementById('matiere_fournisseur').value = '';
            document.getElementById('matiere_stock_min').value = '';
            document.getElementById('matiere_delai').value = '';
        }

        function afficherMatieres() {
            const tbody = document.getElementById('tbody_matieres');
            tbody.innerHTML = '';

            matieresPremiere.forEach(matiere => {
                const row = tbody.insertRow();
                const actionsHtml = currentUser.role === 'admin' ? 
                    `<td><button class="btn btn-danger" onclick="supprimerMatiere(${matiere.id})">üóëÔ∏è</button></td>` : '';
                
                row.innerHTML = `
                    <td><strong>${matiere.reference || ''}</strong></td>
                    <td>${matiere.nom}</td>
                    <td>${getCategorieLabel(matiere.categorie)}</td>
                    <td>${matiere.prix.toFixed(3)} ‚Ç¨/${matiere.unite}</td>
                    <td>${matiere.unite}</td>
                    <td>${getCentreCoutLabel(matiere.centreCout)}</td>
                    <td>${getFamilleLabel(matiere.famille)}</td>
                    <td>${getOrigineLabel(matiere.origine)}</td>
                    <td>${matiere.fournisseur}</td>
                    ${actionsHtml}
                `;
            });
        }

        function getCategorieLabel(categorie) {
            const labels = {
                'ingredient_actif': 'Ingr√©dient actif',
                'excipient': 'Excipient',
                'emballage_primaire': 'Emballage primaire',
                'emballage_secondaire': 'Emballage secondaire',
                'etiquetage': '√âtiquetage',
                'autre': 'Autre'
            };
            return labels[categorie] || categorie;
        }

        function getCentreCoutLabel(centreCout) {
            const labels = {
                'production': 'Production',
                'emballage': 'Emballage',
                'conditionnement': 'Conditionnement',
                'qualite': 'Qualit√©',
                'logistique': 'Logistique'
            };
            return labels[centreCout] || centreCout;
        }

        function getFamilleLabel(famille) {
            const labels = {
                'ingredients': 'Ingr√©dients',
                'emballages': 'Emballages',
                'accessoires': 'Accessoires',
                'etiquettes': '√âtiquettes',
                'consommables': 'Consommables'
            };
            return labels[famille] || famille;
        }

        function getOrigineLabel(origine) {
            const labels = {
                'france': 'üá´üá∑ France',
                'europe': 'üá™üá∫ Europe',
                'asie': 'üåè Asie',
                'amerique': 'üåé Am√©rique',
                'afrique': 'üåç Afrique',
                'oceanie': 'üá¶üá∫ Oc√©anie'
            };
            return labels[origine] || origine;
        }

        function supprimerMatiere(id) {
            if (currentUser.role !== 'admin') return;
            
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette mati√®re premi√®re ?')) {
                matieresPremiere = matieresPremiere.filter(m => m.id !== id);
                afficherMatieres();
                updateMatieresSelect();
                calculerCouts();
            }
        }

        function ajouterEtape() {
            if (currentUser.role !== 'admin') return;
            
            const nom = document.getElementById('etape_nom').value;
            const duree = parseFloat(document.getElementById('etape_duree').value);
            const coutMO = parseFloat(document.getElementById('etape_cout_mo').value);
            const coutMachine = parseFloat(document.getElementById('etape_cout_machine').value) || 0;
            const type = document.getElementById('etape_type').value;
            const ordre = parseInt(document.getElementById('etape_ordre').value) || etapesFabrication.length + 1;
            const description = document.getElementById('etape_description').value;

            if (!nom || !duree || !coutMO) {
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }

            const etape = {
                id: Date.now(),
                nom: nom,
                duree: duree,
                coutMO: coutMO,
                coutMachine: coutMachine,
                type: type,
                ordre: ordre,
                description: description,
                coutTotal: (duree / 60) * coutMO + coutMachine
            };

            etapesFabrication.push(etape);
            etapesFabrication.sort((a, b) => a.ordre - b.ordre);
            afficherEtapes();
            clearEtapeForm();
        }

        function clearEtapeForm() {
            document.getElementById('etape_nom').value = '';
            document.getElementById('etape_duree').value = '';
            document.getElementById('etape_cout_mo').value = '';
            document.getElementById('etape_cout_machine').value = '';
            document.getElementById('etape_description').value = '';
            document.getElementById('etape_ordre').value = '';
        }

        function afficherEtapes() {
            const tbody = document.getElementById('tbody_etapes');
            tbody.innerHTML = '';

            etapesFabrication.forEach(etape => {
                const row = tbody.insertRow();
                const coutMOTotal = (etape.duree / 60) * etape.coutMO;
                const actionsHtml = currentUser.role === 'admin' ? 
                    `<td><button class="btn btn-danger" onclick="supprimerEtape(${etape.id})">üóëÔ∏è</button></td>` : '';
                
                row.innerHTML = `
                    <td>${etape.ordre}</td>
                    <td>${etape.nom}</td>
                    <td>${getTypeLabel(etape.type)}</td>
                    <td>${etape.duree} min</td>
                    <td>${coutMOTotal.toFixed(2)} ‚Ç¨</td>
                    <td>${etape.coutMachine.toFixed(2)} ‚Ç¨</td>
                    <td><strong>${etape.coutTotal.toFixed(2)} ‚Ç¨</strong></td>
                    ${actionsHtml}
                `;
            });
        }

        function getTypeLabel(type) {
            const labels = {
                'preparation': 'Pr√©paration',
                'melange': 'M√©lange',
                'conditionnement': 'Conditionnement',
                'controle': 'Contr√¥le qualit√©',
                'emballage': 'Emballage',
                'autre': 'Autre'
            };
            return labels[type] || type;
        }

        function supprimerEtape(id) {
            if (currentUser.role !== 'admin') return;
            
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette √©tape ?')) {
                etapesFabrication = etapesFabrication.filter(e => e.id !== id);
                afficherEtapes();
                calculerCouts();
            }
        }

        function updateMatieresSelect() {
            const select = document.getElementById('nomenclature_matiere');
            select.innerHTML = '<option value="">S√©lectionnez une mati√®re premi√®re</option>';
            
            matieresPremiere.forEach(matiere => {
                const option = document.createElement('option');
                option.value = matiere.id;
                option.textContent = `${matiere.reference || 'REF'} - ${matiere.nom} (${matiere.prix.toFixed(3)} ‚Ç¨/${matiere.unite})`;
                select.appendChild(option);
            });
        }

        function ajouterNomenclature() {
            if (currentUser.role !== 'admin') return;
            
            const matiereId = parseInt(document.getElementById('nomenclature_matiere').value);
            const quantite = parseFloat(document.getElementById('nomenclature_quantite').value);
            const unite = document.getElementById('nomenclature_unite').value;
            const niveau = parseInt(document.getElementById('nomenclature_niveau').value);

            if (!matiereId || !quantite) {
                alert('Veuillez s√©lectionner une mati√®re premi√®re et saisir la quantit√©.');
                return;
            }

            const matiere = matieresPremiere.find(m => m.id === matiereId);
            if (!matiere) {
                alert('Mati√®re premi√®re non trouv√©e.');
                return;
            }

            if (nomenclatureItems.find(item => item.matiereId === matiereId)) {
                alert('Cette mati√®re premi√®re est d√©j√† dans la nomenclature.');
                return;
            }

            const nomenclatureItem = {
                id: Date.now(),
                matiereId: matiereId,
                matiere: matiere,
                quantite: quantite,
                unite: unite,
                niveau: niveau,
                coutTotal: quantite * matiere.prix
            };

            nomenclatureItems.push(nomenclatureItem);
            afficherNomenclature();
            clearNomenclatureForm();
            calculerCouts();
        }

        function clearNomenclatureForm() {
            document.getElementById('nomenclature_matiere').value = '';
            document.getElementById('nomenclature_quantite').value = '';
        }

        function afficherNomenclature() {
            const tbody = document.getElementById('tbody_nomenclature');
            tbody.innerHTML = '';

            nomenclatureItems.sort((a, b) => a.niveau - b.niveau);

            nomenclatureItems.forEach(item => {
                const row = tbody.insertRow();
                const actionsHtml = currentUser.role === 'admin' ? 
                    `<td><button class="btn btn-danger" onclick="supprimerNomenclature(${item.id})">üóëÔ∏è</button></td>` : '';
                
                row.innerHTML = `
                    <td>
                        <span class="level-indicator level-${item.niveau}">${item.niveau}</span>
                        Niveau ${item.niveau}
                    </td>
                    <td><strong>${item.matiere.reference || 'REF'}</strong></td>
                    <td>${item.matiere.nom}</td>
                    <td>${item.quantite}</td>
                    <td>${item.unite}</td>
                    <td>${item.matiere.prix.toFixed(3)} ‚Ç¨</td>
                    <td>${getCentreCoutLabel(item.matiere.centreCout)}</td>
                    <td>${getFamilleLabel(item.matiere.famille)}</td>
                    <td><strong>${item.coutTotal.toFixed(3)} ‚Ç¨</strong></td>
                    ${actionsHtml}
                `;
            });
        }

        function supprimerNomenclature(id) {
            if (currentUser.role !== 'admin') return;
            
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet √©l√©ment de la nomenclature ?')) {
                nomenclatureItems = nomenclatureItems.filter(item => item.id !== id);
                afficherNomenclature();
                calculerCouts();
            }
        }

        function calculerCouts() {
            const coutMatieres = nomenclatureItems.reduce((total, item) => total + item.coutTotal, 0);
            const coutMainOeuvre = etapesFabrication.reduce((total, etape) => {
                return total + (etape.duree / 60) * etape.coutMO;
            }, 0);
            const coutFabrication = etapesFabrication.reduce((total, etape) => total + etape.coutMachine, 0);
            const coutTotal = coutMatieres + coutMainOeuvre + coutFabrication;
            const prixVente = produitInfo.prix;
            const margeBrute = prixVente - coutTotal;
            const tauxMarge = coutTotal > 0 ? (margeBrute / coutTotal) * 100 : 0;
            const coefficient = coutTotal > 0 ? prixVente / coutTotal : 0;

            document.getElementById('cout_matieres').textContent = coutMatieres.toFixed(2) + ' ‚Ç¨';
            document.getElementById('cout_main_oeuvre').textContent = coutMainOeuvre.toFixed(2) + ' ‚Ç¨';
            document.getElementById('cout_fabrication').textContent = coutFabrication.toFixed(2) + ' ‚Ç¨';
            document.getElementById('cout_total').textContent = coutTotal.toFixed(2) + ' ‚Ç¨';
            document.getElementById('marge_brute').textContent = margeBrute.toFixed(2) + ' ‚Ç¨';
            document.getElementById('taux_marge').textContent = tauxMarge.toFixed(1) + '%';
            document.getElementById('coefficient').textContent = coefficient.toFixed(2);

            afficherRepartition(coutMatieres, coutMainOeuvre, coutFabrication, coutTotal);
        }

        function afficherRepartition(coutMatieres, coutMainOeuvre, coutFabrication, coutTotal) {
            const tbody = document.getElementById('tbody_repartition');
            tbody.innerHTML = '';

            const postes = [
                {
                    nom: 'Mati√®res premi√®res',
                    montant: coutMatieres,
                    detail: `${nomenclatureItems.length} composants`
                },
                {
                    nom: 'Main d\'≈ìuvre',
                    montant: coutMainOeuvre,
                    detail: `${etapesFabrication.length} √©tapes`
                },
                {
                    nom: 'Frais de fabrication',
                    montant: coutFabrication,
                    detail: 'Machines, √©nergie, amortissements'
                }
            ];

            postes.forEach(poste => {
                const pourcentage = coutTotal > 0 ? (poste.montant / coutTotal) * 100 : 0;
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${poste.nom}</strong></td>
                    <td>${poste.montant.toFixed(2)} ‚Ç¨</td>
                    <td>${pourcentage.toFixed(1)}%</td>
                    <td>${poste.detail}</td>
                `;
            });
        }

        // Fonctions d'export/import (simplifi√©es pour s√©curit√©)
        function exporterExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                const wsDataMatieres = [];
                wsDataMatieres.push([
                    'R√©f√©rence', 'D√©signation', 'Cat√©gorie', 'Prix Unitaire', 'Unit√©', 
                    'Centre de Co√ªt', 'Famille', 'Origine', 'Fournisseur', 'Stock Min', 'D√©lai (jours)'
                ]);
                
                matieresPremiere.forEach(matiere => {
                    wsDataMatieres.push([
                        matiere.reference || '',
                        matiere.nom || '',
                        matiere.categorie || '',
                        matiere.prix || 0,
                        matiere.unite || '',
                        matiere.centreCout || '',
                        matiere.famille || '',
                        matiere.origine || '',
                        matiere.fournisseur || '',
                        matiere.stockMin || 0,
                        matiere.delai || 0
                    ]);
                });
                
                const wsMatieres = XLSX.utils.aoa_to_sheet(wsDataMatieres);
                XLSX.utils.book_append_sheet(wb, wsMatieres, "Mati√®res Premi√®res");
                
                const fileName = `Export_${produitInfo.nom.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                document.getElementById('import-status').innerHTML = 
                    '<div class="alert alert-info">‚úÖ Export Excel r√©ussi ! Fichier t√©l√©charg√©: ' + fileName + '</div>';
                    
            } catch (error) {
                console.error('Erreur export Excel:', error);
                document.getElementById('import-status').innerHTML = 
                    '<div class="alert" style="background:#f8d7da;color:#721c24;">‚ùå Erreur lors de l\'export: ' + error.message + '</div>';
            }
        }

        function telechargerTemplate() {
            // Fonction simplifi√©e pour le template
            alert('Template Excel disponible pour les administrateurs');
        }

        function importerExcel(event) {
            if (currentUser.role !== 'admin') {
                alert('Import r√©serv√© aux administrateurs');
                return;
            }
            // Fonction d'import simplifi√©e
        }

        function sauvegarderDonnees() {
            // Fonction de sauvegarde simplifi√©e
        }

        function chargerDonnees() {
            if (currentUser.role !== 'admin') {
                alert('Chargement r√©serv√© aux administrateurs');
                return;
            }
            // Fonction de chargement simplifi√©e
        }

        function genererPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 20;
                let currentY = margin;
                
                function addCenteredText(text, fontSize, y, isBold = false) {
                    pdf.setFontSize(fontSize);
                    if (isBold) pdf.setFont(undefined, 'bold');
                    else pdf.setFont(undefined, 'normal');
                    const textWidth = pdf.getTextWidth(text);
                    pdf.text(text, (pageWidth - textWidth) / 2, y);
                    return y + fontSize * 0.5;
                }
                
                function addLeftText(text, fontSize, x, y, isBold = false) {
                    pdf.setFontSize(fontSize);
                    if (isBold) pdf.setFont(undefined, 'bold');
                    else pdf.setFont(undefined, 'normal');
                    pdf.text(text, x, y);
                    return y + fontSize * 0.6;
                }
                
                // En-t√™te
                pdf.setFillColor(44, 62, 80);
                pdf.rect(0, 0, pageWidth, 40, 'F');
                pdf.setTextColor(255, 255, 255);
                currentY = addCenteredText('CO√õT DE REVIENT & SUIVI DES MARGES', 20, 20, true);
                currentY = addCenteredText(produitInfo.nom, 14, currentY + 5);
                
                pdf.setTextColor(0, 0, 0);
                currentY = 60;
                
                currentY = addLeftText('Date de l\'analyse: ' + new Date().toLocaleDateString('fr-FR'), 10, margin, currentY);
                currentY = addLeftText('G√©n√©r√© par: ' + currentUser.name + ' (' + currentUser.role + ')', 10, margin, currentY);
                currentY = addLeftText('Prix de vente: ' + produitInfo.prix.toFixed(2) + ' ‚Ç¨', 10, margin, currentY);
                currentY += 10;
                
                const coutMatieres = nomenclatureItems.reduce((total, item) => total + item.coutTotal, 0);
                const coutMainOeuvre = etapesFabrication.reduce((total, etape) => total + (etape.duree / 60) * etape.coutMO, 0);
                const coutFabrication = etapesFabrication.reduce((total, etape) => total + etape.coutMachine, 0);
                const coutTotal = coutMatieres + coutMainOeuvre + coutFabrication;
                const margeBrute = produitInfo.prix - coutTotal;
                const tauxMarge = coutTotal > 0 ? (margeBrute / coutTotal) * 100 : 0;
                
                pdf.setFillColor(102, 126, 234);
                pdf.rect(margin, currentY, pageWidth - 2*margin, 8, 'F');
                pdf.setTextColor(255, 255, 255);
                currentY = addLeftText('CO√õTS DE REVIENT', 12, margin + 5, currentY + 6, true);
                pdf.setTextColor(0, 0, 0);
                currentY += 5;
                
                const tableData = [
                    ['Mati√®res Premi√®res', coutMatieres.toFixed(2) + ' ‚Ç¨', ((coutMatieres/coutTotal)*100).toFixed(1) + '%'],
                    ['Main d\'≈íuvre', coutMainOeuvre.toFixed(2) + ' ‚Ç¨', ((coutMainOeuvre/coutTotal)*100).toFixed(1) + '%'],
                    ['Frais de Fabrication', coutFabrication.toFixed(2) + ' ‚Ç¨', ((coutFabrication/coutTotal)*100).toFixed(1) + '%'],
                    ['', '', ''],
                    ['CO√õT TOTAL', coutTotal.toFixed(2) + ' ‚Ç¨', '100%']
                ];
                
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin, currentY, pageWidth - 2*margin, 8, 'F');
                currentY = addLeftText('Poste de co√ªt', 10, margin + 5, currentY + 6, true);
                addLeftText('Montant', 10, margin + 80, currentY - 6, true);
                addLeftText('Pourcentage', 10, margin + 130, currentY - 6, true);
                currentY += 2;
                
                tableData.forEach((row, index) => {
                    const isTotalRow = index === tableData.length - 1;
                    const isEmptyRow = row[0] === '';
                    
                    if (isEmptyRow) {
                        currentY += 3;
                        return;
                    }
                    
                    if (isTotalRow) {
                        pdf.setFillColor(44, 62, 80);
                        pdf.rect(margin, currentY, pageWidth - 2*margin, 8, 'F');
                        pdf.setTextColor(255, 255, 255);
                    }
                    
                    currentY = addLeftText(row[0], 10, margin + 5, currentY + 6, isTotalRow);
                    addLeftText(row[1], 10, margin + 80, currentY - 6, isTotalRow);
                    addLeftText(row[2], 10, margin + 130, currentY - 6, isTotalRow);
                    
                    if (isTotalRow) {
                        pdf.setTextColor(0, 0, 0);
                    }
                    
                    currentY += 2;
                });
                
                currentY += 10;
                
                pdf.setFillColor(40, 167, 69);
                pdf.rect(margin, currentY, pageWidth - 2*margin, 8, 'F');
                pdf.setTextColor(255, 255, 255);
                currentY = addLeftText('ANALYSE DE RENTABILIT√â', 12, margin + 5, currentY + 6, true);
                pdf.setTextColor(0, 0, 0);
                currentY += 8;
                
                currentY = addLeftText('Prix de vente: ' + produitInfo.prix.toFixed(2) + ' ‚Ç¨', 11, margin, currentY, true);
                currentY = addLeftText('Co√ªt de revient: ' + coutTotal.toFixed(2) + ' ‚Ç¨', 11, margin, currentY);
                currentY = addLeftText('Marge brute: ' + margeBrute.toFixed(2) + ' ‚Ç¨', 11, margin, currentY, true);
                currentY = addLeftText('Taux de marge: ' + tauxMarge.toFixed(1) + '%', 11, margin, currentY);
                
                pdf.setFontSize(8);
                pdf.setTextColor(100, 100, 100);
                pdf.text('G√©n√©r√© par l\'outil Co√ªt de revient & Suivi des marges - ' + new Date().toLocaleString('fr-FR'), margin, pageHeight - 10);
                
                const fileName = `Synthese_Cout_Revient_${produitInfo.nom.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
                
                document.getElementById('import-status').innerHTML = 
                    '<div class="alert alert-info">‚úÖ Synth√®se PDF g√©n√©r√©e ! Fichier: ' + fileName + '</div>';
                    
            } catch (error) {
                console.error('Erreur g√©n√©ration PDF:', error);
                document.getElementById('import-status').innerHTML = 
                    '<div class="alert" style="background:#f8d7da;color:#721c24;">‚ùå Erreur lors de la g√©n√©ration PDF: ' + error.message + '</div>';
            }
        }

        // Charger la configuration email sauvegard√©e
        function loadEmailConfig() {
            const savedConfig = localStorage.getItem('emailConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                EMAIL_CONFIG.serviceId = config.serviceId || EMAIL_CONFIG.serviceId;
                EMAIL_CONFIG.templateId = config.templateId || EMAIL_CONFIG.templateId;
                EMAIL_CONFIG.publicKey = config.publicKey || EMAIL_CONFIG.publicKey;
                
                // Mettre √† jour les champs du formulaire
                if (document.getElementById('email_service_id')) {
                    document.getElementById('email_service_id').value = EMAIL_CONFIG.serviceId;
                    document.getElementById('email_template_id').value = EMAIL_CONFIG.templateId;
                    document.getElementById('email_public_key').value = EMAIL_CONFIG.publicKey;
                }
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Charger la configuration email
            loadEmailConfig();
            
            // Initialiser EmailJS
            initEmailJS();
            
            if (!checkSession()) {
                document.getElementById('login-page').style.display = 'block';
                document.getElementById('main-app').style.display = 'none';
            }
            
            updateProduit();
            calculerCouts();
        });
    </script>
</body>
</html>