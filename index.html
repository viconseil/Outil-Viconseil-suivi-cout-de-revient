<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Co√ªt de revient & Suivi des marges - The Gut Cleanser</title>
    <!-- Librairies pour export/import Excel et g√©n√©ration PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- EmailJS pour l'envoi d'emails -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Styles pour la page de connexion */
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 40px;
            text-align: center;
        }
        
        .login-header {
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .login-header p {
            color: #6c757d;
            font-size: 1.1em;
        }
        
        .login-form {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-login {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: transform 0.2s;
        }
        
        .btn-login:hover {
            transform: translateY(-2px);
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }
        
        /* Header avec info utilisateur */
        .user-header {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .user-details h4 {
            margin: 0;
            font-size: 1.1em;
        }
        
        .user-details p {
            margin: 0;
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .logout-btn {
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .logout-btn:hover {
            background: rgba(220, 53, 69, 1);
        }
        
        /* Restrictions visuelles pour les clients */
        .admin-only {
            position: relative;
        }
        
        .admin-only.restricted {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .admin-only.restricted::after {
            content: "üîí Acc√®s administrateur requis";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }
        
        /* Styles existants inchang√©s */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 30px;
            padding: 5px;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .cost-summary {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            margin-top: 30px;
        }
        
        .cost-summary h3 {
            font-size: 1.8em;
            margin-bottom: 15px;
        }
        
        .cost-summary .amount {
            font-size: 2.5em;
            font-weight: bold;
        }

        /* Nouveaux indicateurs avec graphiques */
        .cost-indicator {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .cost-indicator:hover {
            transform: translateY(-5px);
        }

        .indicator-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .indicator-header h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            font-weight: 600;
        }

        .amount-large {
            font-size: 2.2em;
            font-weight: bold;
            margin: 5px 0;
        }

        .percentage {
            font-size: 1.4em;
            font-weight: 600;
            opacity: 0.9;
        }

        .chart-container {
            padding: 15px;
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chart-container-large {
            padding: 20px;
            background: #f8f9fa;
        }

        .indicator-details {
            padding: 15px 20px;
            background: white;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .indicator-details span {
            font-weight: 500;
        }

        .indicator-details span span {
            color: #2c3e50;
            font-weight: bold;
        }

        .historique-stats {
            padding: 15px 20px;
            background: white;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
            border-top: 1px solid #eee;
        }

        .btn-small {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-small:hover {
            background: #c82333;
            transform: scale(1.05);
        }
        
        .level-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            text-align: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            line-height: 20px;
        }
        
        .level-0 { background: #e74c3c; }
        .level-1 { background: #f39c12; }
        .level-2 { background: #27ae60; }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-left: 5px solid #17a2b8;
            color: #0c5460;
        }
        
        .import-export {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #28a745;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
            display: inline-block;
        }
        
        .file-input-label:hover {
            transform: translateY(-2px);
        }
        
        .btn-export {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
        }
        
        .btn-template {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }
        
        /* Onglet Admin */
        .admin-panel {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-left: 5px solid #a71e2a;
        }
        
        .admin-panel h3 {
            color: white;
        }
        
        .user-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            color: #2c3e50;
            border-left: 4px solid #667eea;
        }
        
        .user-card.admin {
            border-left-color: #dc3545;
        }
        
        .user-role {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .role-admin {
            background: #dc3545;
            color: white;
        }
        
        .role-client {
            background: #17a2b8;
            color: white;
        }

        /* Indicateur de sauvegarde */
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            z-index: 10000;
        }

        .save-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .save-indicator.saving {
            background: #ffc107;
            color: #333;
        }

        .save-indicator.error {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Page de connexion -->
    <div id="login-page" class="login-container">
        <div class="login-header">
            <h1>üí∞ Connexion</h1>
            <p>Co√ªt de revient & Suivi des marges</p>
        </div>
        
        <form class="login-form" onsubmit="return login(event)">
            <div class="form-group">
                <label for="username">Nom d'utilisateur</label>
                <input type="text" id="username" required>
            </div>
            
            <div class="form-group">
                <label for="password">Mot de passe</label>
                <input type="password" id="password" required>
            </div>
            
            <button type="submit" class="btn-login">Se connecter</button>
            <button type="button" class="btn-login" onclick="testLoginDebug()" style="background: #dc3545; margin-top: 10px;">üîç Test Debug</button>
            <button type="button" class="btn-login" onclick="voirListeUtilisateurs()" style="background: #6f42c1; margin-top: 10px;">üë• Voir utilisateurs</button>
        </form>
        
        <div id="login-error" class="error-message"></div>
    </div>

    <!-- Indicateur de sauvegarde -->
    <div id="save-indicator" class="save-indicator">
        üíæ Sauvegard√©
    </div>

    <!-- Application principale -->
    <div id="main-app" style="display: none;">
        <div class="user-header">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">A</div>
                <div class="user-details">
                    <h4 id="user-name">Nom d'utilisateur</h4>
                    <p id="user-role">R√¥le utilisateur</p>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">üö™ D√©connexion</button>
        </div>
        
        <div class="container">
            <div class="header">
                <h1>üí∞ Co√ªt de revient & Suivi des marges</h1>
                <p>The Gut Cleanser - Cure d√©tox naturelle antiparasitaire</p>
            </div>
            
            <div class="main-content">
                <div class="tabs">
                    <div class="tab active" onclick="showTab('produit')">üì¶ Produit Final</div>
                    <div class="tab" onclick="showTab('matieres')">üß™ Mati√®res Premi√®res</div>
                    <div class="tab" onclick="showTab('fabrication')">‚öôÔ∏è Fabrication</div>
                    <div class="tab" onclick="showTab('nomenclature')">üìã Nomenclature</div>
                    <div class="tab" onclick="showTab('couts')">üí∞ Analyse du co√ªt de revient</div>
                    <div class="tab admin-only" id="admin-tab" onclick="showTab('admin')">üîß Administration</div>
                </div>
                
                <!-- Onglet Produit Final -->
                <div id="produit" class="tab-content active">
                    <div class="section">
                        <h3>üéØ Informations Produit</h3>
                        <div class="form-row">
                            <div>
                                <label>Nom du produit</label>
                                <input type="text" id="produit_nom" value="Cure d√©tox naturelle antiparasitaire" onchange="updateProduit()">
                            </div>
                            <div>
                                <label>Prix de vente (‚Ç¨)</label>
                                <input type="number" id="produit_prix" value="99.90" step="0.01" onchange="updateProduit()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Quantit√© par cure</label>
                                <input type="number" id="produit_quantite" value="1" onchange="updateProduit()">
                            </div>
                            <div>
                                <label>Unit√©</label>
                                <select id="produit_unite" onchange="updateProduit()">
                                    <option value="cure">Cure compl√®te</option>
                                    <option value="flacon">Flacon</option>
                                    <option value="sachet">Sachet</option>
                                    <option value="g√©lule">G√©lule</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="produit_description" rows="3" onchange="updateProduit()">Cure d√©tox 3-en-1 100% naturelle pour purifier le corps et retrouver de l'√©nergie</textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Onglet Mati√®res Premi√®res -->
                <div id="matieres" class="tab-content">
                    <div class="import-export admin-only">
                        <h3>üìä Import / Export des Donn√©es</h3>
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div class="file-input-wrapper">
                                <input type="file" id="import-excel" accept=".xlsx,.xls,.csv" onchange="importerExcel(event)">
                                <label for="import-excel" class="file-input-label">üì• Importer Excel</label>
                            </div>
                            <button class="btn btn-export" onclick="exporterExcel()">üì§ Exporter Excel</button>
                            <button class="btn btn-template" onclick="telechargerTemplate()">üìã Template Import</button>
                            <button class="btn" onclick="sauvegarderDonnees()">üíæ Sauvegarder</button>
                            <button class="btn" onclick="chargerDonnees()">üìÇ Charger</button>
                        </div>
                        <div id="import-status" style="margin-top: 15px;"></div>
                    </div>
                    
                    <div class="section admin-only">
                        <h3>üß™ Gestion des Mati√®res Premi√®res</h3>
                        <div class="alert alert-info">
                            <strong>üí° Conseil :</strong> Ajoutez tous les ingr√©dients, emballages et mat√©riaux n√©cessaires √† la fabrication.
                        </div>
                        
                        <div class="form-row">
                            <div>
                                <label>R√©f√©rence article</label>
                                <input type="text" id="matiere_reference" placeholder="Ex: MP-001">
                            </div>
                            <div>
                                <label>D√©signation article</label>
                                <input type="text" id="matiere_nom" placeholder="Ex: Extrait d'ail noir">
                            </div>
                            <div>
                                <label>Cat√©gorie</label>
                                <select id="matiere_categorie">
                                    <option value="ingredient_actif">Ingr√©dient actif</option>
                                    <option value="excipient">Excipient</option>
                                    <option value="emballage_primaire">Emballage primaire</option>
                                    <option value="emballage_secondaire">Emballage secondaire</option>
                                    <option value="etiquetage">√âtiquetage</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Prix unitaire (‚Ç¨)</label>
                                <input type="number" id="matiere_prix" step="0.001" placeholder="0.000">
                            </div>
                            <div>
                                <label>Unit√© d'achat</label>
                                <select id="matiere_unite">
                                    <option value="kg">Kilogramme (kg)</option>
                                    <option value="g">Gramme (g)</option>
                                    <option value="l">Litre (l)</option>
                                    <option value="ml">Millilitre (ml)</option>
                                    <option value="piece">Pi√®ce</option>
                                    <option value="m">M√®tre</option>
                                    <option value="m2">M√®tre carr√©</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Fournisseur</label>
                                <input type="text" id="matiere_fournisseur" placeholder="Nom du fournisseur">
                            </div>
                            <div>
                                <label>Centre de co√ªt</label>
                                <select id="matiere_centre_cout">
                                    <option value="production">Production</option>
                                    <option value="emballage">Emballage</option>
                                    <option value="conditionnement">Conditionnement</option>
                                    <option value="qualite">Qualit√©</option>
                                    <option value="logistique">Logistique</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Famille produit</label>
                                <select id="matiere_famille">
                                    <option value="ingredients">Ingr√©dients</option>
                                    <option value="emballages">Emballages</option>
                                    <option value="accessoires">Accessoires</option>
                                    <option value="etiquettes">√âtiquettes</option>
                                    <option value="consommables">Consommables</option>
                                </select>
                            </div>
                            <div>
                                <label>Origine g√©ographique</label>
                                <select id="matiere_origine">
                                    <option value="france">France</option>
                                    <option value="europe">Europe</option>
                                    <option value="asie">Asie</option>
                                    <option value="amerique">Am√©rique</option>
                                    <option value="afrique">Afrique</option>
                                    <option value="oceanie">Oc√©anie</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Stock minimum</label>
                                <input type="number" id="matiere_stock_min" step="0.1" placeholder="Quantit√© minimum">
                            </div>
                            <div>
                                <label>D√©lai approvisionnement (jours)</label>
                                <input type="number" id="matiere_delai" step="1" placeholder="Ex: 15">
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="ajouterMatiere()">‚ûï Ajouter la mati√®re premi√®re</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üì¶ Liste des Mati√®res Premi√®res</h3>
                        <table id="table_matieres">
                            <thead>
                                <tr>
                                    <th>R√©f√©rence</th>
                                    <th>D√©signation article</th>
                                    <th>Cat√©gorie</th>
                                    <th>Prix unitaire</th>
                                    <th>Unit√©</th>
                                    <th>Centre de co√ªt</th>
                                    <th>Famille</th>
                                    <th>Origine</th>
                                    <th>Fournisseur</th>
                                    <th class="admin-only">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_matieres">
                                <!-- Les mati√®res seront ajout√©es ici -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Onglet Fabrication -->
                <div id="fabrication" class="tab-content">
                    <div class="section admin-only">
                        <h3>‚öôÔ∏è √âtapes de Fabrication</h3>
                        <div class="alert alert-info">
                            <strong>üí° Conseil :</strong> D√©finissez chaque √©tape avec ses co√ªts (main d'≈ìuvre, machines, √©nergie...).
                        </div>
                        
                        <div class="form-row">
                            <div>
                                <label>Nom de l'√©tape</label>
                                <input type="text" id="etape_nom" placeholder="Ex: M√©lange des ingr√©dients">
                            </div>
                            <div>
                                <label>Dur√©e (minutes)</label>
                                <input type="number" id="etape_duree" step="1" placeholder="Dur√©e en minutes">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Co√ªt horaire main d'≈ìuvre (‚Ç¨/h)</label>
                                <input type="number" id="etape_cout_mo" step="0.01" placeholder="25.00">
                            </div>
                            <div>
                                <label>Co√ªt machine/√©nergie (‚Ç¨)</label>
                                <input type="number" id="etape_cout_machine" step="0.01" placeholder="0.50">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Type d'√©tape</label>
                                <select id="etape_type">
                                    <option value="preparation">Pr√©paration</option>
                                    <option value="melange">M√©lange</option>
                                    <option value="conditionnement">Conditionnement</option>
                                    <option value="controle">Contr√¥le qualit√©</option>
                                    <option value="emballage">Emballage</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                            <div>
                                <label>Ordre d'ex√©cution</label>
                                <input type="number" id="etape_ordre" step="1" placeholder="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description d√©taill√©e</label>
                            <textarea id="etape_description" rows="3" placeholder="D√©crivez pr√©cis√©ment cette √©tape de fabrication..."></textarea>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="ajouterEtape()">‚ûï Ajouter l'√©tape</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üîÑ Process de Fabrication</h3>
                        <table id="table_etapes">
                            <thead>
                                <tr>
                                    <th>Ordre</th>
                                    <th>√âtape</th>
                                    <th>Type</th>
                                    <th>Dur√©e</th>
                                    <th>Co√ªt M.O.</th>
                                    <th>Co√ªt Machine</th>
                                    <th>Co√ªt Total</th>
                                    <th class="admin-only">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_etapes">
                                <!-- Les √©tapes seront ajout√©es ici -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Onglet Nomenclature -->
                <div id="nomenclature" class="tab-content">
                    <div class="section admin-only">
                        <h3>üìã Composition du Produit</h3>
                        <div class="alert alert-info">
                            <strong>üí° Conseil :</strong> D√©finissez la quantit√© exacte de chaque mati√®re premi√®re n√©cessaire pour 1 unit√© de produit fini.
                        </div>
                        
                        <div class="form-row">
                            <div>
                                <label>Mati√®re premi√®re</label>
                                <select id="nomenclature_matiere">
                                    <option value="">S√©lectionnez une mati√®re premi√®re</option>
                                    <!-- Options remplies dynamiquement -->
                                </select>
                            </div>
                            <div>
                                <label>Quantit√© n√©cessaire</label>
                                <input type="number" id="nomenclature_quantite" step="0.001" placeholder="Quantit√©">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Unit√© de consommation</label>
                                <select id="nomenclature_unite">
                                    <option value="kg">Kilogramme (kg)</option>
                                    <option value="g">Gramme (g)</option>
                                    <option value="l">Litre (l)</option>
                                    <option value="ml">Millilitre (ml)</option>
                                    <option value="piece">Pi√®ce</option>
                                    <option value="m">M√®tre</option>
                                    <option value="m2">M√®tre carr√©</option>
                                </select>
                            </div>
                            <div>
                                <label>Niveau hi√©rarchique</label>
                                <select id="nomenclature_niveau">
                                    <option value="0">Niveau 0 - Produit fini</option>
                                    <option value="1">Niveau 1 - Composant principal</option>
                                    <option value="2">Niveau 2 - Mati√®re premi√®re</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="ajouterNomenclature()">‚ûï Ajouter √† la nomenclature</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üèóÔ∏è Structure de la Nomenclature</h3>
                        <table id="table_nomenclature">
                            <thead>
                                <tr>
                                    <th>Niveau</th>
                                    <th>R√©f√©rence</th>
                                    <th>D√©signation article</th>
                                    <th>Quantit√©</th>
                                    <th>Unit√©</th>
                                    <th>Prix unitaire</th>
                                    <th>Centre de co√ªt</th>
                                    <th>Famille</th>
                                    <th>Co√ªt total</th>
                                    <th class="admin-only">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_nomenclature">
                                <!-- La nomenclature sera affich√©e ici -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Onglet Co√ªts -->
                <div id="couts" class="tab-content">
                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>üí∞ Analyse des Co√ªts de Revient</h3>
                            <button class="btn" onclick="actualiserCouts()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); padding: 10px 20px;">
                                üîÑ Actualiser les calculs
                            </button>
                        </div>
                        
                        <!-- Indicateurs Principaux avec Mini-Graphiques -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                            <!-- Co√ªt de Revient Total -->
                            <div class="cost-indicator">
                                <div class="indicator-header">
                                    <h3>üí∞ CO√õT DE REVIENT TOTAL</h3>
                                    <div class="amount-large" id="cout_total">0.00 ‚Ç¨</div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="chart_cout_repartition" width="200" height="120"></canvas>
                                </div>
                                <div class="indicator-details">
                                    <span>Mati√®res: <span id="cout_matieres">0.00 ‚Ç¨</span></span>
                                    <span>MO: <span id="cout_main_oeuvre">0.00 ‚Ç¨</span></span>
                                    <span>Fabrication: <span id="cout_fabrication">0.00 ‚Ç¨</span></span>
                                </div>
                            </div>

                            <!-- Marge Brute -->
                            <div class="cost-indicator">
                                <div class="indicator-header">
                                    <h3>üìà MARGE BRUTE</h3>
                                    <div class="amount-large" id="marge_brute">0.00 ‚Ç¨</div>
                                    <div class="percentage" id="taux_marge">0.0%</div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="chart_marge_ca" width="200" height="120"></canvas>
                                </div>
                                <div class="indicator-details">
                                    <span>Prix Vente: <span id="prix_vente_display">99.90 ‚Ç¨</span></span>
                                    <span>Coefficient: <span id="coefficient">0.0</span></span>
                                </div>
                            </div>

                            <!-- √âvolution des Marges -->
                            <div class="cost-indicator" style="grid-column: span 2;">
                                <div class="indicator-header">
                                    <h3>üìä HISTORIQUE DES MARGES</h3>
                                    <button class="btn-small" onclick="effacerHistorique()">üóëÔ∏è Effacer</button>
                                </div>
                                <div class="chart-container-large">
                                    <canvas id="chart_historique_marge" width="600" height="200"></canvas>
                                </div>
                                <div class="historique-stats">
                                    <span>Derni√®re mise √† jour: <span id="derniere_maj">-</span></span>
                                    <span>Nombre d'analyses: <span id="nb_analyses">0</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üìä R√©partition des Co√ªts</h3>
                        <table id="table_repartition">
                            <thead>
                                <tr>
                                    <th>Poste de co√ªt</th>
                                    <th>Montant (‚Ç¨)</th>
                                    <th>Pourcentage</th>
                                    <th>D√©tail</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_repartition">
                                <!-- La r√©partition sera calcul√©e automatiquement -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); text-align: center;">
                        <h3>üìÑ G√©n√©rer la Synth√®se PDF</h3>
                        <p style="margin-bottom: 20px; color: #6c757d;">Cr√©ez un rapport professionnel avec tous les indicateurs de co√ªt</p>
                        <button class="btn" onclick="genererPDF()" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); font-size: 1.1em; padding: 15px 30px;">üìã G√©n√©rer le Rapport PDF</button>
                    </div>
                </div>
                
                <!-- Onglet Administration -->
                <div id="admin" class="tab-content">
                    <div class="section admin-panel">
                        <h3>üîß Panel d'Administration</h3>
                        <p style="margin-bottom: 20px;">Gestion des utilisateurs et param√®tres syst√®me</p>
                    </div>
                    
                    <div class="section">
                        <h3>üë• Cr√©er un nouvel utilisateur</h3>
                        <div class="form-row">
                            <div>
                                <label>Nom complet</label>
                                <input type="text" id="new_user_name" placeholder="Ex: Jean Dupont">
                            </div>
                            <div>
                                <label>Email</label>
                                <input type="email" id="new_user_email" placeholder="jean.dupont@client.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Entreprise</label>
                                <input type="text" id="new_user_company" placeholder="Nom de l'entreprise">
                            </div>
                            <div>
                                <label>R√¥le</label>
                                <select id="new_user_role">
                                    <option value="client">Client</option>
                                    <option value="admin">Administrateur</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="creerUtilisateur()">‚ûï Cr√©er l'utilisateur</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üìã Liste des utilisateurs</h3>
                        <div id="users-list">
                            <!-- Les utilisateurs seront affich√©s ici -->
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üìß Configuration Email</h3>
                        <div class="alert alert-info">
                            <strong>üí° Configuration EmailJS avec bouton cliquable :</strong><br>
                            1. Cr√©ez un compte sur <a href="https://emailjs.com" target="_blank">EmailJS.com</a><br>
                            2. Configurez un service email (Gmail, Outlook, etc.)<br>
                            3. Cr√©ez un template avec les variables: to_email, to_name, user_name, user_password, login_url, message<br>
                            4. <strong>Important :</strong> Ajoutez un bouton HTML dans votre template EmailJS<br>
                            5. Saisissez vos cl√©s ci-dessous
                        </div>
                        
                        
                        <div class="form-row">
                            <div>
                                <label>Service ID</label>
                                <input type="text" id="email_service_id" placeholder="Ex: service_viconseil" value="service_viconseil">
                            </div>
                            <div>
                                <label>Template ID</label>
                                <input type="text" id="email_template_id" placeholder="Ex: template_user_credentials" value="template_user_credentials">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Public Key</label>
                                <input type="text" id="email_public_key" placeholder="Ex: your_public_key_here" value="your_public_key_here">
                            </div>
                            <div>
                                <label>Email de r√©ponse</label>
                                <input type="email" id="email_reply_to" placeholder="vincent@viconseil.com" value="vincent@viconseil.com">
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="updateEmailConfig()">üìß Mettre √† jour la config email</button>
                            <button class="btn" onclick="testEmail()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">üß™ Tester l'envoi</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üîë Modifier mes identifiants admin</h3>
                        <div class="form-row">
                            <div>
                                <label>Nouveau nom d'utilisateur</label>
                                <input type="text" id="admin_new_username" placeholder="Actuel: viconseil">
                            </div>
                            <div>
                                <label>Nouveau mot de passe</label>
                                <input type="password" id="admin_new_password" placeholder="Actuel: mdpadmin">
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="modifierAdminCredentials()">üîÑ Mettre √† jour</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration EmailJS (√† remplacer par vos vraies cl√©s)
        const EMAIL_CONFIG = {
            serviceId: 'service_viconseil',
            templateId: 'template_user_credentials',
            publicKey: 'your_public_key_here'
        };

        // Initialiser EmailJS
        function initEmailJS() {
            if (typeof emailjs !== 'undefined') {
                emailjs.init(EMAIL_CONFIG.publicKey);
            }
        }

        // Fonction d'envoi d'email r√©el avec diagnostic d√©taill√©
        function envoyerEmailReel(email, name, username, password, emailContent) {
            return new Promise((resolve, reject) => {
                console.log('üîÑ D√âBUT ENVOI EMAIL - Diagnostic:');
                console.log('- Destinataire:', email);
                console.log('- EmailJS loaded:', typeof emailjs !== 'undefined');
                console.log('- Service ID:', EMAIL_CONFIG.serviceId);
                console.log('- Template ID:', EMAIL_CONFIG.templateId);
                console.log('- Public Key configur√©e:', EMAIL_CONFIG.publicKey !== 'your_public_key_here');
                
                if (typeof emailjs === 'undefined') {
                    console.error('‚ùå EmailJS library non charg√©e');
                    reject(new Error('EmailJS not loaded'));
                    return;
                }

                const templateParams = {
                    to_email: email,
                    to_name: name,
                    user_name: username,
                    user_password: password,
                    login_url: window.location.href,
                    message: emailContent,
                    from_name: 'VI Conseil',
                    reply_to: 'vincent@viconseil.com'
                };

                console.log('üìß Param√®tres template:', templateParams);
                console.log('üöÄ Tentative envoi...');

                emailjs.send(EMAIL_CONFIG.serviceId, EMAIL_CONFIG.templateId, templateParams)
                    .then((response) => {
                        console.log('‚úÖ Email envoy√© avec succ√®s:', response);
                        console.log('- Status:', response.status);
                        console.log('- Text:', response.text);
                        resolve(response);
                    })
                    .catch((error) => {
                        console.error('‚ùå ERREUR ENVOI EMAIL:', error);
                        console.error('- Status:', error.status);
                        console.error('- Text:', error.text);
                        console.error('- Message:', error.message);
                        console.error('- Stack:', error.stack);
                        
                        // Am√©liorer le message d'erreur selon le type
                        let enhancedError = { 
                            ...error,
                            originalError: error,
                            debugInfo: {
                                serviceId: EMAIL_CONFIG.serviceId,
                                templateId: EMAIL_CONFIG.templateId,
                                publicKeyConfigured: EMAIL_CONFIG.publicKey !== 'your_public_key_here',
                                emailjsLoaded: typeof emailjs !== 'undefined'
                            }
                        };
                        
                        if (error.status === 400) {
                            enhancedError.userMessage = "Service EmailJS en d√©faut - Probl√®me d'authentification";
                            enhancedError.solution = "V√©rifiez vos identifiants dans EmailJS Dashboard";
                        } else if (error.status === 401) {
                            enhancedError.userMessage = "Cl√© API EmailJS incorrecte";
                            enhancedError.solution = "V√©rifiez votre Public Key";
                        } else if (error.status === 404) {
                            enhancedError.userMessage = "Service ID ou Template ID introuvable";
                            enhancedError.solution = "V√©rifiez vos IDs dans EmailJS Dashboard";
                        } else if (error.text && error.text.includes('gmail')) {
                            enhancedError.userMessage = "Probl√®me authentification Gmail";
                            enhancedError.solution = "Recr√©ez votre mot de passe d'application";
                        } else if (error.text && error.text.includes('quota')) {
                            enhancedError.userMessage = "Quota EmailJS d√©pass√©";
                            enhancedError.solution = "Attendez le renouvellement ou upgradez votre plan";
                        } else {
                            enhancedError.userMessage = "Erreur inconnue: " + (error.message || error.text || 'Aucun d√©tail');
                            enhancedError.solution = "Consultez la console pour plus de d√©tails";
                        }
                        
                        reject(enhancedError);
                    });
            });
        }

        // Syst√®me d'authentification et gestion des utilisateurs
        let currentUser = null;
        let users = [
            {
                id: 1,
                username: 'viconseil',
                password: 'mdpadmin',
                name: 'Vincent - VI Conseil',
                email: 'vincent@viconseil.com',
                role: 'admin',
                company: 'VI Conseil'
            }
        ];

        // Variables globales pour les donn√©es (inchang√©es)
        let matieresPremiere = [];
        let etapesFabrication = [];
        let nomenclatureItems = [];
        let produitInfo = {
            nom: "Cure d√©tox naturelle antiparasitaire",
            prix: 99.90,
            quantite: 1,
            unite: "cure",
            description: "Cure d√©tox 3-en-1 100% naturelle pour purifier le corps et retrouver de l'√©nergie"
        };

        // Syst√®me de sauvegarde automatique
        let saveTimeout;
        let isDataLoaded = false;

        function showSaveIndicator(status = 'success', message = 'üíæ Sauvegard√©') {
            const indicator = document.getElementById('save-indicator');
            indicator.textContent = message;
            indicator.className = 'save-indicator show';
            
            if (status === 'saving') {
                indicator.classList.add('saving');
                indicator.textContent = '‚è≥ Sauvegarde...';
            } else if (status === 'error') {
                indicator.classList.add('error');
                indicator.textContent = '‚ùå Erreur sauvegarde';
            }
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        function autoSave() {
            if (!isDataLoaded) return; // √âviter de sauvegarder lors du chargement initial
            
            clearTimeout(saveTimeout);
            showSaveIndicator('saving');
            
            saveTimeout = setTimeout(() => {
                try {
                    const dataToSave = {
                        matieresPremiere: matieresPremiere,
                        etapesFabrication: etapesFabrication,
                        nomenclatureItems: nomenclatureItems,
                        produitInfo: produitInfo,
                        users: users,
                        timestamp: new Date().toISOString(),
                        version: '1.0'
                    };
                    
                    localStorage.setItem('coutRevientData', JSON.stringify(dataToSave));
                    showSaveIndicator('success', 'üíæ Sauvegard√© automatiquement');
                    
                } catch (error) {
                    console.error('Erreur sauvegarde:', error);
                    showSaveIndicator('error');
                }
            }, 1000); // D√©lai de 1 seconde pour √©viter trop de sauvegardes
        }

        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('coutRevientData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    if (data.version && data.matieresPremiere) {
                        matieresPremiere = data.matieresPremiere || [];
                        etapesFabrication = data.etapesFabrication || [];
                        nomenclatureItems = data.nomenclatureItems || [];
                        produitInfo = { ...produitInfo, ...data.produitInfo };
                        
                        // Charger les utilisateurs depuis la sauvegarde
                        if (data.users) {
                            users = data.users;
                        }
                        
                        console.log('Donn√©es charg√©es depuis localStorage:', new Date(data.timestamp));
                        return true;
                    }
                }
            } catch (error) {
                console.error('Erreur chargement donn√©es:', error);
            }
            return false;
        }

        function forceBackup() {
            if (currentUser && currentUser.role === 'admin') {
                autoSave();
                alert('Sauvegarde manuelle effectu√©e !');
            }
        }

        // Fonction pour voir la liste des utilisateurs
        function voirListeUtilisateurs() {
            console.log('üë• LISTE DES UTILISATEURS:');
            users.forEach((user, index) => {
                console.log(`${index + 1}. Username: "${user.username}" | Password: "${user.password}" | Name: "${user.name}" | Role: "${user.role}"`);
            });
            
            let userList = 'Utilisateurs disponibles:\n\n';
            users.forEach((user, index) => {
                userList += `${index + 1}. "${user.username}" / "${user.password}" (${user.name})\n`;
            });
            alert(userList);
        }

        // Fonction de test pour diagnostiquer le probl√®me
        function testLoginDebug() {
            console.log('üîç TEST DEBUG CONNEXION:');
            console.log('- Function testLoginDebug appel√©e');
            console.log('- Nombre d\'utilisateurs:', users.length);
            console.log('- Utilisateurs disponibles:', users);
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            console.log('- Username saisi:', username);
            console.log('- Password saisi:', password);
            
            // Test de connexion manuelle
            const user = users.find(u => u.username === username && u.password === password);
            console.log('- Utilisateur trouv√©:', user);
            
            if (user) {
                alert('‚úÖ Utilisateur trouv√© ! Connexion devrait marcher.');
                login({preventDefault: () => {}});
            } else {
                alert('‚ùå Utilisateur non trouv√©. V√©rifiez les identifiants.');
            }
        }

        // Fonctions d'authentification
        function login(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            // DEBUG : Afficher les informations de connexion
            console.log('üîç TENTATIVE DE CONNEXION:');
            console.log('- Username saisi:', username);
            console.log('- Password saisi:', password);
            console.log('- Nombre d\'utilisateurs dans la base:', users.length);
            console.log('- Liste des utilisateurs:', users.map(u => ({
                username: u.username, 
                password: u.password, 
                name: u.name,
                role: u.role
            })));
            
            const user = users.find(u => u.username === username && u.password === password);
            
            console.log('- Utilisateur trouv√©:', user ? 'OUI' : 'NON');
            
            if (user) {
                console.log('‚úÖ Connexion r√©ussie pour:', user.name);
                currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(user));
                showMainApp();
            } else {
                console.log('‚ùå Connexion √©chou√©e');
                console.log('- V√©rification username exact:', users.find(u => u.username === username) ? 'Username OK' : 'Username INTROUVABLE');
                console.log('- V√©rification password:', users.find(u => u.password === password) ? 'Password OK' : 'Password INTROUVABLE');
                
                errorDiv.textContent = 'Nom d\'utilisateur ou mot de passe incorrect';
                errorDiv.style.display = 'block';
            }
            
            return false;
        }

        function logout() {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-page').style.display = 'block';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showMainApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            // Mettre √† jour l'interface utilisateur
            document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Administrateur' : 'Client';
            
            // Appliquer les restrictions selon le r√¥le
            applyRoleRestrictions();
            
            // Charger les donn√©es sauvegard√©es
            loadSavedData();
            refreshAllDisplays();
            isDataLoaded = true; // Activer la sauvegarde automatique apr√®s le chargement
            
            // Charger les donn√©es si c'est un admin
            if (currentUser.role === 'admin') {
                chargerUtilisateurs();
            }
        }

        function applyRoleRestrictions() {
            const adminElements = document.querySelectorAll('.admin-only');
            
            if (currentUser.role !== 'admin') {
                adminElements.forEach(element => {
                    element.classList.add('restricted');
                });
                // Masquer l'onglet admin pour les clients
                document.getElementById('admin-tab').style.display = 'none';
            } else {
                adminElements.forEach(element => {
                    element.classList.remove('restricted');
                });
                document.getElementById('admin-tab').style.display = 'block';
            }
        }

        // Fonctions de gestion des utilisateurs (Admin seulement)
        function creerUtilisateur() {
            if (currentUser.role !== 'admin') return;
            
            const name = document.getElementById('new_user_name').value;
            const email = document.getElementById('new_user_email').value;
            const company = document.getElementById('new_user_company').value;
            const role = document.getElementById('new_user_role').value;
            
            if (!name || !email) {
                alert('Veuillez remplir le nom et l\'email');
                return;
            }
            
            // G√©n√©rer identifiants automatiques
            const username = email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');
            const password = generatePassword();
            
            const newUser = {
                id: users.length + 1,
                username: username,
                password: password,
                name: name,
                email: email,
                role: role,
                company: company
            };
            
            users.push(newUser);
            autoSave(); // Sauvegarde automatique
            
            // Envoi d'email r√©el via EmailJS
            const emailContent = `
Bonjour ${name},

Votre acc√®s √† l'outil "Co√ªt de revient & Suivi des marges" a √©t√© cr√©√© avec succ√®s.

Vos identifiants de connexion :
‚Ä¢ Nom d'utilisateur : ${username}
‚Ä¢ Mot de passe : ${password}

Pour vous connecter, cliquez directement sur le bouton dans cet email ou utilisez le lien ci-dessous.

Cordialement,
L'√©quipe VI Conseil
            `;
            
            // Tenter l'envoi d'email r√©el
            envoyerEmailReel(email, name, username, password, emailContent)
                .then(() => {
                    alert(`Utilisateur cr√©√© avec succ√®s !
                    
Identifiants g√©n√©r√©s :
- Nom d'utilisateur : ${username}
- Mot de passe : ${password}

‚úÖ Un email a √©t√© envoy√© √† ${email} avec ces informations.`);
                })
                .catch((error) => {
                    console.error('Erreur envoi email:', error);
                    
                    // Fallback : afficher les infos et permettre copie
                    const emailWindow = window.open('', '_blank', 'width=600,height=500');
                    emailWindow.document.write(`
                        <html>
                        <head><title>Identifiants Client - √Ä envoyer manuellement</title></head>
                        <body style="font-family: Arial, sans-serif; padding: 20px;">
                            <h2>‚ö†Ô∏è Email automatique non envoy√©</h2>
                            <p><strong>Utilisateur cr√©√© :</strong> ${name}</p>
                            <p><strong>Email :</strong> ${email}</p>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h3>üìß Contenu √† envoyer manuellement :</h3>
                                <textarea style="width: 100%; height: 200px; font-family: monospace;">${emailContent}</textarea>
                            </div>
                            
                            <button onclick="navigator.clipboard.writeText(document.querySelector('textarea').value).then(() => alert('Contenu copi√© !'))" 
                                    style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                                üìã Copier le contenu
                            </button>
                            
                            <p style="color: #666; margin-top: 20px;">
                                <small>Veuillez copier ce contenu et l'envoyer manuellement √† ${email}</small>
                            </p>
                        </body>
                        </html>
                    `);
                    
                    alert(`Utilisateur cr√©√© avec succ√®s !
                    
Identifiants g√©n√©r√©s :
- Nom d'utilisateur : ${username}
- Mot de passe : ${password}

‚ö†Ô∏è L'email automatique n'a pas pu √™tre envoy√©.
Une fen√™tre s'est ouverte avec le contenu √† envoyer manuellement √† ${email}.`);
                });
            
            // Vider le formulaire
            document.getElementById('new_user_name').value = '';
            document.getElementById('new_user_email').value = '';
            document.getElementById('new_user_company').value = '';
            
            chargerUtilisateurs();
        }

        function generatePassword() {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        function chargerUtilisateurs() {
            if (currentUser.role !== 'admin') return;
            
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            
            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = `user-card ${user.role}`;
                userCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${user.name} <span class="user-role role-${user.role}">${user.role.toUpperCase()}</span></h4>
                            <p><strong>Email:</strong> ${user.email}</p>
                            <p><strong>Entreprise:</strong> ${user.company}</p>
                            <p><strong>Identifiants:</strong> ${user.username} / ${user.password}</p>
                        </div>
                        <div>
                            ${user.role !== 'admin' ? `<button class="btn btn-danger" onclick="supprimerUtilisateur(${user.id})">üóëÔ∏è Supprimer</button>` : ''}
                        </div>
                    </div>
                `;
                usersList.appendChild(userCard);
            });
        }

        function supprimerUtilisateur(userId) {
            if (currentUser.role !== 'admin') return;
            
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur ?')) {
                users = users.filter(u => u.id !== userId);
                chargerUtilisateurs();
                autoSave(); // Sauvegarde automatique
            }
        }

        function updateEmailConfig() {
            if (currentUser.role !== 'admin') return;
            
            EMAIL_CONFIG.serviceId = document.getElementById('email_service_id').value;
            EMAIL_CONFIG.templateId = document.getElementById('email_template_id').value;
            EMAIL_CONFIG.publicKey = document.getElementById('email_public_key').value;
            
            // R√©initialiser EmailJS avec la nouvelle cl√©
            if (typeof emailjs !== 'undefined' && EMAIL_CONFIG.publicKey !== 'your_public_key_here') {
                emailjs.init(EMAIL_CONFIG.publicKey);
            }
            
            // Sauvegarder dans le localStorage
            localStorage.setItem('emailConfig', JSON.stringify(EMAIL_CONFIG));
            
            alert('Configuration email mise √† jour avec succ√®s !');
        }



        function reparerServiceEmail() {
            if (currentUser.role !== 'admin') return;
            
            const reparationWindow = window.open('', '_blank', 'width=900,height=800,scrollbars=yes');
            reparationWindow.document.write(`
                <html>
                <head>
                    <title>üõ†Ô∏è R√©parer Service Email en D√©faut - EmailJS</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
                        .problem { background: #f8d7da; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 5px solid #dc3545; color: #721c24; }
                        .solution { background: #d4edda; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 5px solid #28a745; color: #155724; }
                        .warning { background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 5px solid #ffc107; color: #856404; }
                        .code { background: #f4f4f4; padding: 10px; border-radius: 5px; font-family: monospace; margin: 10px 0; }
                        .steps { background: #d1ecf1; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 5px solid #17a2b8; color: #0c5460; }
                        h2 { color: #dc3545; }
                        h3 { color: #28a745; }
                    </style>
                </head>
                <body>
                    <h1>üõ†Ô∏è Service EmailJS en D√©faut - Solutions</h1>
                    
                    <div class="problem">
                        <h2>‚ùå Probl√®mes courants Gmail :</h2>
                        <p><strong>1. Mot de passe d'application incorrect/expir√©</strong></p>
                        <p><strong>2. Validation 2 √©tapes non activ√©e</strong></p>
                        <p><strong>3. "Acc√®s aux applications moins s√©curis√©es" d√©sactiv√©</strong></p>
                        <p><strong>4. Compte Gmail avec restrictions entreprise</strong></p>
                    </div>

                    <div class="solution">
                        <h3>‚úÖ Solution 1 : Recr√©er le mot de passe d'application Gmail</h3>
                        <div class="steps">
                            <p><strong>√âtapes :</strong></p>
                            <p>1. Allez sur <a href="https://myaccount.google.com/security" target="_blank">myaccount.google.com/security</a></p>
                            <p>2. Section "Connexion √† Google" ‚Üí V√©rification en 2 √©tapes</p>
                            <p>3. En bas, cliquez "Mots de passe d'application"</p>
                            <p>4. Supprimez l'ancien mot de passe EmailJS</p>
                            <p>5. Cr√©ez un nouveau : "Autre" ‚Üí "EmailJS VI Conseil"</p>
                            <p>6. Copiez le nouveau mot de passe de 16 caract√®res</p>
                            <p>7. Dans EmailJS Dashboard ‚Üí Edit Service ‚Üí remplacez le mot de passe</p>
                            <p>8. Testez la connexion</p>
                        </div>
                    </div>

                    <div class="solution">
                        <h3>‚úÖ Solution 2 : Alternative Outlook (RECOMMAND√â)</h3>
                        <div class="steps">
                            <p><strong>Plus simple et plus stable que Gmail :</strong></p>
                            <p>1. Cr√©ez un compte Outlook.com gratuit (si pas d√©j√† fait)</p>
                            <p>2. Dans EmailJS Dashboard ‚Üí Add New Service ‚Üí "Outlook"</p>
                            <p>3. Remplissez simplement :</p>
                            <div class="code">
                            Service ID: service_viconseil_outlook<br>
                            Email: votre-email@outlook.com<br>
                            Password: votre mot de passe normal (pas d'application)
                            </div>
                            <p>4. Test Connection ‚Üí doit √™tre ‚úÖ</p>
                            <p>5. Mettez √† jour le Service ID dans VI Conseil</p>
                        </div>
                    </div>

                    <div class="warning">
                        <h3>‚ö†Ô∏è V√©rifications importantes :</h3>
                        <p><strong>EmailJS Dashboard :</strong></p>
                        <p>‚Ä¢ Status du service doit √™tre "Connected" ‚úÖ (pas "Failed" ‚ùå)</p>
                        <p>‚Ä¢ Test connection doit passer</p>
                        <p>‚Ä¢ Quota emails : v√©rifiez qu'il vous reste des envois</p>
                        <p><strong>Compte Gmail :</strong></p>
                        <p>‚Ä¢ Validation 2 √©tapes ACTIV√âE</p>
                        <p>‚Ä¢ Mot de passe d'application VALIDE</p>
                        <p>‚Ä¢ Pas de restrictions de s√©curit√© entreprise</p>
                    </div>

                    <div class="solution">
                        <h3>‚úÖ Solution 3 : Yahoo Mail (Alternative)</h3>
                        <div class="steps">
                            <p>1. Yahoo Account Security ‚Üí Generate App Password</p>
                            <p>2. EmailJS ‚Üí Add Service ‚Üí "Yahoo"</p>
                            <p>3. Utilisez le mot de passe d'application g√©n√©r√©</p>
                        </div>
                    </div>

                    <div class="problem">
                        <h2>üö® Test de v√©rification :</h2>
                        <p>1. Dans EmailJS Dashboard ‚Üí Services ‚Üí cliquez votre service</p>
                        <p>2. "Test Connection" doit afficher ‚úÖ Success</p>
                        <p>3. Si ‚ùå Failed ‚Üí le probl√®me est dans l'authentification email</p>
                        <p>4. Si ‚úÖ Success ‚Üí le probl√®me est dans vos cl√©s API</p>
                    </div>

                    <div style="text-align: center; margin: 30px 0;">
                        <button onclick="window.close()" style="background: #007bff; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Fermer et appliquer les solutions</button>
                    </div>
                </body>
                </html>
            `);
        }

        function ouvrirGuideConfiguration() {
            const guideWindow = window.open('', '_blank', 'width=800,height=700,scrollbars=yes');
            guideWindow.document.write(`
                <html>
                <head>
                    <title>Guide Configuration EmailJS - VI Conseil</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
                        .step { background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 5px solid #007bff; }
                        .code { background: #f4f4f4; padding: 10px; border-radius: 5px; font-family: monospace; margin: 10px 0; }
                        .warning { background: #fff3cd; border-left-color: #ffc107; }
                        .success { background: #d4edda; border-left-color: #28a745; }
                        img { max-width: 100%; border: 1px solid #ddd; margin: 10px 0; }
                    </style>
                </head>
                <body>
                    <h1>üîß Configuration EmailJS pour VI Conseil</h1>
                    
                    <div class="step">
                        <h3>üìã √âtape 1 : Cr√©er un compte EmailJS</h3>
                        <p>1. Allez sur <a href="https://emailjs.com" target="_blank">https://emailjs.com</a></p>
                        <p>2. Cliquez sur "Sign Up" et cr√©ez votre compte</p>
                        <p>3. Confirmez votre email</p>
                    </div>

                    <div class="step">
                        <h3>üìß √âtape 2 : Configurer Gmail</h3>
                        <p><strong>‚ö†Ô∏è Important :</strong> Gmail n√©cessite un "mot de passe d'application"</p>
                        <p>1. Allez dans votre compte Google ‚Üí S√©curit√©</p>
                        <p>2. Activez la "Validation en 2 √©tapes"</p>
                        <p>3. G√©n√©rez un "Mot de passe d'application" pour EmailJS</p>
                        <p>4. Notez ce mot de passe (16 caract√®res sans espaces)</p>
                    </div>

                    <div class="step">
                        <h3>üîó √âtape 3 : Ajouter service Gmail dans EmailJS</h3>
                        <p>1. Dans EmailJS Dashboard ‚Üí "Email Services"</p>
                        <p>2. Cliquez "Add Service" ‚Üí Choisir "Gmail"</p>
                        <p>3. Remplissez :</p>
                        <div class="code">
                        Service ID: <strong>service_viconseil</strong> (ou votre choix)<br>
                        Email: <strong>votre-email@gmail.com</strong><br>
                        Password: <strong>le mot de passe d'application de 16 caract√®res</strong>
                        </div>
                        <p>4. Testez la connexion et sauvegardez</p>
                    </div>

                    <div class="step">
                        <h3>üìù √âtape 4 : Cr√©er le template email</h3>
                        <p>1. Dans EmailJS Dashboard ‚Üí "Email Templates"</p>
                        <p>2. Cliquez "Create New Template"</p>
                        <p>3. Template ID: <strong>template_user_credentials</strong></p>
                        <p>4. Copiez ce contenu exact :</p>
                        <div class="code">
<strong>Subject:</strong> Vos identifiants - Outil Co√ªt de revient VI Conseil<br><br>
<strong>Content:</strong><br>
Bonjour {{to_name}},<br><br>
Voici vos identifiants pour acc√©der √† l'outil "Co√ªt de revient & Suivi des marges" :<br><br>
URL : {{login_url}}<br>
Nom d'utilisateur : {{user_name}}<br>
Mot de passe : {{user_password}}<br><br>
{{message}}<br><br>
Cordialement,<br>
VI Conseil<br>
Email: {{reply_to}}
                        </div>
                        <p>5. Sauvegardez le template</p>
                    </div>

                    <div class="step">
                        <h3>üîë √âtape 5 : R√©cup√©rer les cl√©s</h3>
                        <p>1. <strong>Service ID :</strong> Dans "Email Services" ‚Üí copiez l'ID de votre service Gmail</p>
                        <p>2. <strong>Template ID :</strong> Dans "Email Templates" ‚Üí copiez l'ID de votre template</p>
                        <p>3. <strong>Public Key :</strong> Dans "Account" ‚Üí "API Keys" ‚Üí copiez la "Public Key"</p>
                    </div>

                    <div class="step success">
                        <h3>‚úÖ √âtape 6 : Configuration finale</h3>
                        <p>1. Retournez dans votre outil VI Conseil ‚Üí onglet Administration</p>
                        <p>2. Collez vos 3 cl√©s dans les champs correspondants</p>
                        <p>3. Cliquez "Mettre √† jour la config email"</p>
                        <p>4. Utilisez "Test d'envoi" pour v√©rifier</p>
                    </div>

                    <div class="step warning">
                        <h3>‚ùó Erreurs courantes</h3>
                        <p><strong>‚Ä¢ Email non re√ßu :</strong> V√©rifiez les spams, mot de passe d'application Gmail</p>
                        <p><strong>‚Ä¢ Erreur 401 :</strong> Public Key incorrecte</p>
                        <p><strong>‚Ä¢ Erreur 404 :</strong> Service ID ou Template ID incorrect</p>
                        <p><strong>‚Ä¢ Variables vides :</strong> V√©rifiez l'orthographe des variables dans le template</p>
                    </div>

                    <p><button onclick="window.close()" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Fermer ce guide</button></p>
                </body>
                </html>
            `);
        }

        function ouvrirTemplateEmail() {
            const templateWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
            templateWindow.document.write(`
                <html>
                <head>
                    <title>üìß Template EmailJS avec Bouton - VI Conseil</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
                        .template-box { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 5px solid #28a745; margin: 20px 0; }
                        .html-code { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 13px; line-height: 1.4; overflow-x: auto; }
                        .step { background: #e7f3ff; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 5px solid #007bff; }
                        .warning { background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 5px solid #ffc107; color: #856404; }
                        h2 { color: #28a745; }
                    </style>
                </head>
                <body>
                    <h1>üìß Template EmailJS avec Bouton Cliquable</h1>
                    
                    <div class="step">
                        <h3>üìã Instructions :</h3>
                        <p>1. Allez dans EmailJS Dashboard ‚Üí Email Templates</p>
                        <p>2. √âditez votre template existant ou cr√©ez-en un nouveau</p>
                        <p>3. Copiez-collez le code HTML ci-dessous dans le contenu du template</p>
                        <p>4. Sauvegardez le template</p>
                    </div>

                    <div class="template-box">
                        <h3>‚úâÔ∏è Template Email complet √† copier :</h3>
                        <p><strong>Subject :</strong> Vos identifiants - Outil Co√ªt de revient VI Conseil</p>
                        <p><strong>Contenu HTML :</strong></p>
                        <div class="html-code"><!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .email-container { max-width: 600px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .content { padding: 30px; }
        .credentials { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 5px solid #28a745; }
        .btn-access { display: inline-block; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 16px; margin: 20px 0; text-align: center; }
        .btn-access:hover { background: linear-gradient(135deg, #20c997 0%, #28a745 100%); }
        .footer { background: #f8f9fa; padding: 20px; text-align: center; color: #6c757d; font-size: 14px; }
        .link-fallback { color: #007bff; word-break: break-all; }
    </style>
</head>
<body>
    <div class="email-container">
        <div class="header">
            <h1>üí∞ VI Conseil</h1>
            <p>Outil Co√ªt de revient & Suivi des marges</p>
        </div>
        
        <div class="content">
            <h2>Bonjour {{to_name}},</h2>
            
            <p>Votre acc√®s √† l'outil <strong>"Co√ªt de revient & Suivi des marges"</strong> a √©t√© cr√©√© avec succ√®s.</p>
            
            <div class="credentials">
                <h3>üîë Vos identifiants de connexion :</h3>
                <p><strong>Nom d'utilisateur :</strong> {{user_name}}</p>
                <p><strong>Mot de passe :</strong> {{user_password}}</p>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <a href="{{login_url}}" class="btn-access">üöÄ ACC√âDER √Ä L'OUTIL</a>
            </div>
            
            <p>{{message}}</p>
            
            <div class="footer">
                <p><strong>Lien direct :</strong><br>
                <a href="{{login_url}}" class="link-fallback">{{login_url}}</a></p>
                
                <p>Si le bouton ne fonctionne pas, copiez et collez le lien ci-dessus dans votre navigateur.</p>
                
                <hr style="margin: 20px 0; border: none; height: 1px; background: #dee2e6;">
                
                <p>Cordialement,<br>
                <strong>L'√©quipe VI Conseil</strong><br>
                Email: contact@viconseil.com</p>
            </div>
        </div>
    </div>
</body>
</html></div>
                    </div>

                    <div class="warning">
                        <h3>‚ö†Ô∏è Important :</h3>
                        <p>‚Ä¢ Utilisez le mode <strong>"Rich Text/HTML"</strong> dans EmailJS</p>
                        <p>‚Ä¢ Assurez-vous que toutes les variables {{}} sont pr√©sentes</p>
                        <p>‚Ä¢ Testez le template avec le bouton "Test d'envoi"</p>
                        <p>‚Ä¢ Le bouton sera cliquable dans l'email re√ßu</p>
                    </div>

                    <div style="text-align: center; margin: 30px 0;">
                        <button onclick="navigator.clipboard.writeText(document.querySelector('.html-code').textContent).then(() => alert('Template copi√© dans le presse-papier!'))" 
                                style="background: #28a745; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-right: 10px;">
                            üìã Copier le template
                        </button>
                        <button onclick="window.close()" 
                                style="background: #6c757d; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            Fermer
                        </button>
                    </div>
                </body>
                </html>
            `);
        }

        function testEmail() {
            if (currentUser.role !== 'admin') return;
            
            const testEmail = prompt('Entrez une adresse email pour tester l\'envoi :');
            if (!testEmail) return;
            
            console.log('‚è≥ Test d\'envoi en cours...');
            
            const emailContent = `
TEST du nouveau template avec bouton cliquable.

Si vous recevez cet email avec un bouton "ACC√âDER √Ä L'OUTIL", le template fonctionne parfaitement !

Heure du test : ${new Date().toLocaleString('fr-FR')}

Cordialement,
VI Conseil - Test Template
            `;
            
            envoyerEmailReel(testEmail, 'Test EmailJS', 'test_user', 'test_password', emailContent)
                .then((response) => {
                    console.log('‚úÖ Test email success:', response);
                    alert(`‚úÖ Email de test envoy√© avec succ√®s !\n\nDestinataire : ${testEmail}\nStatus : ${response.status} - ${response.text}`);
                })
                .catch((error) => {
                    console.error('‚ùå Test email error:', error);
                    let errorMsg = `‚ùå Erreur lors de l'envoi :\n\n`;
                    errorMsg += `Type : ${error.name || 'Erreur inconnue'}\n`;
                    errorMsg += `Message : ${error.text || error.message || 'Aucun d√©tail'}\n`;
                    errorMsg += `Status : ${error.status || 'Non d√©fini'}\n\n`;
                    errorMsg += `Solutions possibles :\n`;
                    
                    if (error.status === 401) {
                        errorMsg += `‚Ä¢ V√©rifiez votre Public Key EmailJS\n`;
                    } else if (error.status === 404) {
                        errorMsg += `‚Ä¢ V√©rifiez vos Service ID et Template ID\n`;
                    } else if (error.text && error.text.includes('gmail')) {
                        errorMsg += `‚Ä¢ V√©rifiez votre mot de passe d'application Gmail\n`;
                    } else {
                        errorMsg += `‚Ä¢ Consultez la console pour plus de d√©tails\n`;
                    }
                    
                    alert(errorMsg);
                });
        }

        function modifierAdminCredentials() {
            if (currentUser.role !== 'admin') return;
            
            const newUsername = document.getElementById('admin_new_username').value;
            const newPassword = document.getElementById('admin_new_password').value;
            
            if (!newUsername && !newPassword) {
                alert('Veuillez saisir au moins un nouveau param√®tre');
                return;
            }
            
            const adminUser = users.find(u => u.id === currentUser.id);
            
            if (newUsername) {
                adminUser.username = newUsername;
                currentUser.username = newUsername;
            }
            
            if (newPassword) {
                adminUser.password = newPassword;
                currentUser.password = newPassword;
            }
            
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            autoSave(); // Sauvegarde automatique
            
            alert('Identifiants administrateur mis √† jour avec succ√®s !');
            
            document.getElementById('admin_new_username').value = '';
            document.getElementById('admin_new_password').value = '';
        }

        // V√©rification de session au chargement
        function checkSession() {
            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showMainApp();
                return true;
            }
            return false;
        }

        // Toutes les autres fonctions existantes (inchang√©es)
        function showTab(tabName) {
            // V√©rifier les droits d'acc√®s
            if (tabName === 'admin' && currentUser.role !== 'admin') {
                alert('Acc√®s r√©serv√© aux administrateurs');
                return;
            }
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'nomenclature') {
                updateMatieresSelect();
            }
            if (tabName === 'couts') {
                calculerCouts();
            }
            if (tabName === 'admin') {
                chargerUtilisateurs();
            }
        }

        function updateProduit() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            produitInfo.nom = document.getElementById('produit_nom').value;
            produitInfo.prix = parseFloat(document.getElementById('produit_prix').value) || 0;
            produitInfo.quantite = parseFloat(document.getElementById('produit_quantite').value) || 1;
            produitInfo.unite = document.getElementById('produit_unite').value;
            produitInfo.description = document.getElementById('produit_description').value;
            
            document.getElementById('prix_vente_display').textContent = produitInfo.prix.toFixed(2) + ' ‚Ç¨';
            calculerCouts();
            autoSave(); // Sauvegarde automatique
        }

        function ajouterMatiere() {
            if (currentUser.role !== 'admin') return;
            
            const reference = document.getElementById('matiere_reference').value;
            const nom = document.getElementById('matiere_nom').value;
            const categorie = document.getElementById('matiere_categorie').value;
            const prix = parseFloat(document.getElementById('matiere_prix').value);
            const unite = document.getElementById('matiere_unite').value;
            const fournisseur = document.getElementById('matiere_fournisseur').value;
            const centreCout = document.getElementById('matiere_centre_cout').value;
            const famille = document.getElementById('matiere_famille').value;
            const origine = document.getElementById('matiere_origine').value;
            const stockMin = parseFloat(document.getElementById('matiere_stock_min').value) || 0;
            const delai = parseInt(document.getElementById('matiere_delai').value) || 0;

            if (!reference || !nom || !prix) {
                alert('Veuillez remplir au minimum la r√©f√©rence, le nom et le prix de la mati√®re premi√®re.');
                return;
            }

            if (matieresPremiere.find(m => m.reference === reference)) {
                alert('Cette r√©f√©rence existe d√©j√†. Veuillez utiliser une r√©f√©rence unique.');
                return;
            }

            const matiere = {
                id: Date.now(),
                reference: reference,
                nom: nom,
                categorie: categorie,
                prix: prix,
                unite: unite,
                fournisseur: fournisseur,
                centreCout: centreCout,
                famille: famille,
                origine: origine,
                stockMin: stockMin,
                delai: delai
            };

            matieresPremiere.push(matiere);
            afficherMatieres();
            clearMatiereForm();
            updateMatieresSelect();
            autoSave(); // Sauvegarde automatique
        }

        function clearMatiereForm() {
            document.getElementById('matiere_reference').value = '';
            document.getElementById('matiere_nom').value = '';
            document.getElementById('matiere_prix').value = '';
            document.getElementById('matiere_fournisseur').value = '';
            document.getElementById('matiere_stock_min').value = '';
            document.getElementById('matiere_delai').value = '';
        }

        function afficherMatieres() {
            const tbody = document.getElementById('tbody_matieres');
            tbody.innerHTML = '';

            matieresPremiere.forEach(matiere => {
                const row = tbody.insertRow();
                const actionsHtml = currentUser.role === 'admin' ? 
                    `<td><button class="btn btn-danger" onclick="supprimerMatiere(${matiere.id})">üóëÔ∏è</button></td>` : '';
                
                row.innerHTML = `
                    <td><strong>${matiere.reference || ''}</strong></td>
                    <td>${matiere.nom}</td>
                    <td>${getCategorieLabel(matiere.categorie)}</td>
                    <td>${matiere.prix.toFixed(3)} ‚Ç¨/${matiere.unite}</td>
                    <td>${matiere.unite}</td>
                    <td>${getCentreCoutLabel(matiere.centreCout)}</td>
                    <td>${getFamilleLabel(matiere.famille)}</td>
                    <td>${getOrigineLabel(matiere.origine)}</td>
                    <td>${matiere.fournisseur}</td>
                    ${actionsHtml}
                `;
            });
        }

        function getCategorieLabel(categorie) {
            const labels = {
                'ingredient_actif': 'Ingr√©dient actif',
                'excipient': 'Excipient',
                'emballage_primaire': 'Emballage primaire',
                'emballage_secondaire': 'Emballage secondaire',
                'etiquetage': '√âtiquetage',
                'autre': 'Autre'
            };
            return labels[categorie] || categorie;
        }

        function getCentreCoutLabel(centreCout) {
            const labels = {
                'production': 'Production',
                'emballage': 'Emballage',
                'conditionnement': 'Conditionnement',
                'qualite': 'Qualit√©',
                'logistique': 'Logistique'
            };
            return labels[centreCout] || centreCout;
        }

        function getFamilleLabel(famille) {
            const labels = {
                'ingredients': 'Ingr√©dients',
                'emballages': 'Emballages',
                'accessoires': 'Accessoires',
                'etiquettes': '√âtiquettes',
                'consommables': 'Consommables'
            };
            return labels[famille] || famille;
        }

        function getOrigineLabel(origine) {
            const labels = {
                'france': 'üá´üá∑ France',
                'europe': 'üá™üá∫ Europe',
                'asie': 'üåè Asie',
                'amerique': 'üåé Am√©rique',
                'afrique': 'üåç Afrique',
                'oceanie': 'üá¶üá∫ Oc√©anie'
            };
            return labels[origine] || origine;
        }

        function supprimerMatiere(id) {
            if (currentUser.role !== 'admin') return;
            
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette mati√®re premi√®re ?')) {
                matieresPremiere = matieresPremiere.filter(m => m.id !== id);
                afficherMatieres();
                updateMatieresSelect();
                calculerCouts();
                autoSave(); // Sauvegarde automatique
            }
        }

        function ajouterEtape() {
            if (currentUser.role !== 'admin') return;
            
            const nom = document.getElementById('etape_nom').value;
            const duree = parseFloat(document.getElementById('etape_duree').value);
            const coutMO = parseFloat(document.getElementById('etape_cout_mo').value);
            const coutMachine = parseFloat(document.getElementById('etape_cout_machine').value) || 0;
            const type = document.getElementById('etape_type').value;
            const ordre = parseInt(document.getElementById('etape_ordre').value) || etapesFabrication.length + 1;
            const description = document.getElementById('etape_description').value;

            if (!nom || !duree || !coutMO) {
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }

            const etape = {
                id: Date.now(),
                nom: nom,
                duree: duree,
                coutMO: coutMO,
                coutMachine: coutMachine,
                type: type,
                ordre: ordre,
                description: description,
                coutTotal: (duree / 60) * coutMO + coutMachine
            };

            etapesFabrication.push(etape);
            etapesFabrication.sort((a, b) => a.ordre - b.ordre);
            afficherEtapes();
            clearEtapeForm();
            autoSave(); // Sauvegarde automatique
        }

        function clearEtapeForm() {
            document.getElementById('etape_nom').value = '';
            document.getElementById('etape_duree').value = '';
            document.getElementById('etape_cout_mo').value = '';
            document.getElementById('etape_cout_machine').value = '';
            document.getElementById('etape_description').value = '';
            document.getElementById('etape_ordre').value = '';
        }

        function afficherEtapes() {
            const tbody = document.getElementById('tbody_etapes');
            tbody.innerHTML = '';

            etapesFabrication.forEach(etape => {
                const row = tbody.insertRow();
                const coutMOTotal = (etape.duree / 60) * etape.coutMO;
                const actionsHtml = currentUser.role === 'admin' ? 
                    `<td><button class="btn btn-danger" onclick="supprimerEtape(${etape.id})">üóëÔ∏è</button></td>` : '';
                
                row.innerHTML = `
                    <td>${etape.ordre}</td>
                    <td>${etape.nom}</td>
                    <td>${getTypeLabel(etape.type)}</td>
                    <td>${etape.duree} min</td>
                    <td>${coutMOTotal.toFixed(2)} ‚Ç¨</td>
                    <td>${etape.coutMachine.toFixed(2)} ‚Ç¨</td>
                    <td><strong>${etape.coutTotal.toFixed(2)} ‚Ç¨</strong></td>
                    ${actionsHtml}
                `;
            });
        }

        function getTypeLabel(type) {
            const labels = {
                'preparation': 'Pr√©paration',
                'melange': 'M√©lange',
                'conditionnement': 'Conditionnement',
                'controle': 'Contr√¥le qualit√©',
                'emballage': 'Emballage',
                'autre': 'Autre'
            };
            return labels[type] || type;
        }

        function supprimerEtape(id) {
            if (currentUser.role !== 'admin') return;
            
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette √©tape ?')) {
                etapesFabrication = etapesFabrication.filter(e => e.id !== id);
                afficherEtapes();
                calculerCouts();
                autoSave(); // Sauvegarde automatique
            }
        }

        function updateMatieresSelect() {
            const select = document.getElementById('nomenclature_matiere');
            select.innerHTML = '<option value="">S√©lectionnez une mati√®re premi√®re</option>';
            
            matieresPremiere.forEach(matiere => {
                const option = document.createElement('option');
                option.value = matiere.id;
                option.textContent = `${matiere.reference || 'REF'} - ${matiere.nom} (${matiere.prix.toFixed(3)} ‚Ç¨/${matiere.unite})`;
                select.appendChild(option);
            });
        }

        function ajouterNomenclature() {
            if (currentUser.role !== 'admin') return;
            
            const matiereId = parseInt(document.getElementById('nomenclature_matiere').value);
            const quantite = parseFloat(document.getElementById('nomenclature_quantite').value);
            const unite = document.getElementById('nomenclature_unite').value;
            const niveau = parseInt(document.getElementById('nomenclature_niveau').value);

            if (!matiereId || !quantite) {
                alert('Veuillez s√©lectionner une mati√®re premi√®re et saisir la quantit√©.');
                return;
            }

            const matiere = matieresPremiere.find(m => m.id === matiereId);
            if (!matiere) {
                alert('Mati√®re premi√®re non trouv√©e.');
                return;
            }

            if (nomenclatureItems.find(item => item.matiereId === matiereId)) {
                alert('Cette mati√®re premi√®re est d√©j√† dans la nomenclature.');
                return;
            }

            const nomenclatureItem = {
                id: Date.now(),
                matiereId: matiereId,
                matiere: matiere,
                quantite: quantite,
                unite: unite,
                niveau: niveau,
                coutTotal: quantite * matiere.prix
            };

            nomenclatureItems.push(nomenclatureItem);
            afficherNomenclature();
            clearNomenclatureForm();
            calculerCouts();
            autoSave(); // Sauvegarde automatique
        }

        function clearNomenclatureForm() {
            document.getElementById('nomenclature_matiere').value = '';
            document.getElementById('nomenclature_quantite').value = '';
        }

        function afficherNomenclature() {
            const tbody = document.getElementById('tbody_nomenclature');
            tbody.innerHTML = '';

            nomenclatureItems.sort((a, b) => a.niveau - b.niveau);

            nomenclatureItems.forEach(item => {
                const row = tbody.insertRow();
                const actionsHtml = currentUser.role === 'admin' ? 
                    `<td><button class="btn btn-danger" onclick="supprimerNomenclature(${item.id})">üóëÔ∏è</button></td>` : '';
                
                row.innerHTML = `
                    <td>
                        <span class="level-indicator level-${item.niveau}">${item.niveau}</span>
                        Niveau ${item.niveau}
                    </td>
                    <td><strong>${item.matiere.reference || 'REF'}</strong></td>
                    <td>${item.matiere.nom}</td>
                    <td>${item.quantite}</td>
                    <td>${item.unite}</td>
                    <td>${item.matiere.prix.toFixed(3)} ‚Ç¨</td>
                    <td>${getCentreCoutLabel(item.matiere.centreCout)}</td>
                    <td>${getFamilleLabel(item.matiere.famille)}</td>
                    <td><strong>${item.coutTotal.toFixed(3)} ‚Ç¨</strong></td>
                    ${actionsHtml}
                `;
            });
        }

        function supprimerNomenclature(id) {
            if (currentUser.role !== 'admin') return;
            
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet √©l√©ment de la nomenclature ?')) {
                nomenclatureItems = nomenclatureItems.filter(item => item.id !== id);
                afficherNomenclature();
                calculerCouts();
                autoSave(); // Sauvegarde automatique
            }
        }

        function calculerCouts() {
            const coutMatieres = nomenclatureItems.reduce((total, item) => total + item.coutTotal, 0);
            const coutMainOeuvre = etapesFabrication.reduce((total, etape) => {
                return total + (etape.duree / 60) * etape.coutMO;
            }, 0);
            const coutFabrication = etapesFabrication.reduce((total, etape) => total + etape.coutMachine, 0);
            const coutTotal = coutMatieres + coutMainOeuvre + coutFabrication;
            const prixVente = produitInfo.prix;
            const margeBrute = prixVente - coutTotal;
            const tauxMarge = prixVente > 0 ? (margeBrute / prixVente) * 100 : 0;
            const coefficient = coutTotal > 0 ? prixVente / coutTotal : 0;

            document.getElementById('cout_matieres').textContent = coutMatieres.toFixed(2) + ' ‚Ç¨';
            document.getElementById('cout_main_oeuvre').textContent = coutMainOeuvre.toFixed(2) + ' ‚Ç¨';
            document.getElementById('cout_fabrication').textContent = coutFabrication.toFixed(2) + ' ‚Ç¨';
            document.getElementById('cout_total').textContent = coutTotal.toFixed(2) + ' ‚Ç¨';
            document.getElementById('marge_brute').textContent = margeBrute.toFixed(2) + ' ‚Ç¨';
            document.getElementById('taux_marge').textContent = tauxMarge.toFixed(1) + '%';
            document.getElementById('coefficient').textContent = coefficient.toFixed(2);

            afficherRepartition(coutMatieres, coutMainOeuvre, coutFabrication, coutTotal);
            
            // Mettre √† jour les graphiques
            creerGraphiqueRepartition(coutMatieres, coutMainOeuvre, coutFabrication);
            creerGraphiqueMargeCA(margeBrute, coutTotal, prixVente);
            
            // Ajouter √† l'historique
            ajouterAHistorique(margeBrute, tauxMarge, coutTotal, prixVente);
            
            // Mettre √† jour le prix de vente affich√©
            document.getElementById('prix_vente_display').textContent = prixVente.toFixed(2) + ' ‚Ç¨';
        }

        function afficherRepartition(coutMatieres, coutMainOeuvre, coutFabrication, coutTotal) {
            const tbody = document.getElementById('tbody_repartition');
            tbody.innerHTML = '';

            const postes = [
                {
                    nom: 'Mati√®res premi√®res',
                    montant: coutMatieres,
                    detail: `${nomenclatureItems.length} composants`
                },
                {
                    nom: 'Main d\'≈ìuvre',
                    montant: coutMainOeuvre,
                    detail: `${etapesFabrication.length} √©tapes`
                },
                {
                    nom: 'Frais de fabrication',
                    montant: coutFabrication,
                    detail: 'Machines, √©nergie, amortissements'
                }
            ];

            postes.forEach(poste => {
                const pourcentage = coutTotal > 0 ? (poste.montant / coutTotal) * 100 : 0;
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${poste.nom}</strong></td>
                    <td>${poste.montant.toFixed(2)} ‚Ç¨</td>
                    <td>${pourcentage.toFixed(1)}%</td>
                    <td>${poste.detail}</td>
                `;
            });
        }

        // Variables globales pour l'historique des marges
        let historiqueMarges = JSON.parse(localStorage.getItem('historique_marges') || '[]');

        // Fonction pour actualiser les calculs
        function actualiserCouts() {
            showSaveIndicator('saving', 'üîÑ Recalcul en cours...');
            calculerCouts();
            showSaveIndicator('success', '‚úÖ Calculs actualis√©s');
        }

        // Fonction pour cr√©er le graphique de r√©partition des co√ªts
        function creerGraphiqueRepartition(coutMatieres, coutMainOeuvre, coutFabrication) {
            const canvas = document.getElementById('chart_cout_repartition');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // D√©truire le graphique existant s'il y en a un
            if (window.chartRepartition) {
                window.chartRepartition.destroy();
            }

            const data = {
                labels: ['Mati√®res', 'Main d\'≈ìuvre', 'Fabrication'],
                datasets: [{
                    data: [coutMatieres, coutMainOeuvre, coutFabrication],
                    backgroundColor: [
                        '#3498db',
                        '#f39c12', 
                        '#9b59b6'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            };

            window.chartRepartition = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                fontSize: 10,
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        // Fonction pour cr√©er le graphique marge/CA
        function creerGraphiqueMargeCA(margeBrute, coutTotal, prixVente) {
            const canvas = document.getElementById('chart_marge_ca');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // D√©truire le graphique existant
            if (window.chartMargeCA) {
                window.chartMargeCA.destroy();
            }

            const data = {
                labels: ['Marge Brute', 'Co√ªt de Revient'],
                datasets: [{
                    data: [margeBrute, coutTotal],
                    backgroundColor: [
                        '#27ae60',
                        '#e74c3c'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            };

            window.chartMargeCA = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                fontSize: 10,
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        // Fonction pour ajouter une entr√©e √† l'historique
        function ajouterAHistorique(margeBrute, tauxMarge, coutTotal, prixVente) {
            const maintenant = new Date();
            const entree = {
                date: maintenant.toISOString(),
                dateAffichage: maintenant.toLocaleString('fr-FR'),
                margeBrute: margeBrute,
                tauxMarge: tauxMarge,
                coutTotal: coutTotal,
                prixVente: prixVente
            };

            historiqueMarges.push(entree);
            
            // Garder seulement les 50 derni√®res entr√©es
            if (historiqueMarges.length > 50) {
                historiqueMarges = historiqueMarges.slice(-50);
            }

            // Sauvegarder dans localStorage
            localStorage.setItem('historique_marges', JSON.stringify(historiqueMarges));

            // Mettre √† jour l'affichage
            mettreAJourHistorique();
        }

        // Fonction pour mettre √† jour l'affichage de l'historique
        function mettreAJourHistorique() {
            const canvas = document.getElementById('chart_historique_marge');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            
            // D√©truire le graphique existant
            if (window.chartHistorique) {
                window.chartHistorique.destroy();
            }

            // Prendre les 20 derni√®res entr√©es
            const dernieresEntrees = historiqueMarges.slice(-20);
            
            const labels = dernieresEntrees.map(entree => {
                const date = new Date(entree.date);
                return date.toLocaleDateString('fr-FR', { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            });
            
            const donneesMarges = dernieresEntrees.map(entree => entree.tauxMarge);
            const donneesPrix = dernieresEntrees.map(entree => entree.prixVente);
            
            window.chartHistorique = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Taux de Marge (%)',
                        data: donneesMarges,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Prix de Vente (‚Ç¨)',
                        data: donneesPrix,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Taux de Marge (%)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Prix de Vente (‚Ç¨)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });

            // Mettre √† jour les statistiques
            document.getElementById('derniere_maj').textContent = historiqueMarges.length > 0 ? 
                new Date(historiqueMarges[historiqueMarges.length - 1].date).toLocaleString('fr-FR') : 
                '-';
            document.getElementById('nb_analyses').textContent = historiqueMarges.length;
        }

        // Fonction pour effacer l'historique
        function effacerHistorique() {
            if (confirm('√ätes-vous s√ªr de vouloir effacer tout l\'historique des marges ?')) {
                historiqueMarges = [];
                localStorage.removeItem('historique_marges');
                mettreAJourHistorique();
                showSaveIndicator('success', 'üóëÔ∏è Historique effac√©');
            }
        }

        // Fonctions d'export/import (simplifi√©es pour s√©curit√©)
        function exporterExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                const wsDataMatieres = [];
                wsDataMatieres.push([
                    'R√©f√©rence', 'D√©signation', 'Cat√©gorie', 'Prix Unitaire', 'Unit√©', 
                    'Centre de Co√ªt', 'Famille', 'Origine', 'Fournisseur', 'Stock Min', 'D√©lai (jours)'
                ]);
                
                matieresPremiere.forEach(matiere => {
                    wsDataMatieres.push([
                        matiere.reference || '',
                        matiere.nom || '',
                        matiere.categorie || '',
                        matiere.prix || 0,
                        matiere.unite || '',
                        matiere.centreCout || '',
                        matiere.famille || '',
                        matiere.origine || '',
                        matiere.fournisseur || '',
                        matiere.stockMin || 0,
                        matiere.delai || 0
                    ]);
                });
                
                const wsMatieres = XLSX.utils.aoa_to_sheet(wsDataMatieres);
                XLSX.utils.book_append_sheet(wb, wsMatieres, "Mati√®res Premi√®res");
                
                const fileName = `Export_${produitInfo.nom.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                document.getElementById('import-status').innerHTML = 
                    '<div class="alert alert-info">‚úÖ Export Excel r√©ussi ! Fichier t√©l√©charg√©: ' + fileName + '</div>';
                    
            } catch (error) {
                console.error('Erreur export Excel:', error);
                document.getElementById('import-status').innerHTML = 
                    '<div class="alert" style="background:#f8d7da;color:#721c24;">‚ùå Erreur lors de l\'export: ' + error.message + '</div>';
            }
        }

        function telechargerTemplate() {
            // Fonction simplifi√©e pour le template
            alert('Template Excel disponible pour les administrateurs');
        }

        function importerExcel(event) {
            if (currentUser.role !== 'admin') {
                alert('Import r√©serv√© aux administrateurs');
                return;
            }
            // Fonction d'import simplifi√©e
        }

        function refreshAllDisplays() {
            // Actualiser tous les affichages apr√®s chargement des donn√©es
            if (produitInfo) {
                document.getElementById('produit_nom').value = produitInfo.nom || '';
                document.getElementById('produit_prix').value = produitInfo.prix || 0;
                document.getElementById('produit_quantite').value = produitInfo.quantite || 1;
                document.getElementById('produit_unite').value = produitInfo.unite || 'cure';
                document.getElementById('produit_description').value = produitInfo.description || '';
                document.getElementById('prix_vente_display').textContent = (produitInfo.prix || 0).toFixed(2) + ' ‚Ç¨';
            }
            
            afficherMatieres();
            afficherEtapes();
            afficherNomenclature();
            updateMatieresSelect();
            calculerCouts();
        }

        function sauvegarderDonnees() {
            forceBackup();
        }

        function chargerDonnees() {
            if (currentUser.role !== 'admin') {
                alert('Chargement r√©serv√© aux administrateurs');
                return;
            }
            
            if (confirm('Voulez-vous recharger les donn√©es depuis la derni√®re sauvegarde ?')) {
                isDataLoaded = false; // D√©sactiver temporairement l'auto-save
                loadSavedData();
                refreshAllDisplays();
                isDataLoaded = true;
                alert('Donn√©es recharg√©es avec succ√®s !');
            }
        }

        function genererPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 20;
                let currentY = margin;
                
                function addCenteredText(text, fontSize, y, isBold = false) {
                    pdf.setFontSize(fontSize);
                    if (isBold) pdf.setFont(undefined, 'bold');
                    else pdf.setFont(undefined, 'normal');
                    const textWidth = pdf.getTextWidth(text);
                    pdf.text(text, (pageWidth - textWidth) / 2, y);
                    return y + fontSize * 0.5;
                }
                
                function addLeftText(text, fontSize, x, y, isBold = false) {
                    pdf.setFontSize(fontSize);
                    if (isBold) pdf.setFont(undefined, 'bold');
                    else pdf.setFont(undefined, 'normal');
                    pdf.text(text, x, y);
                    return y + fontSize * 0.6;
                }
                
                // En-t√™te
                pdf.setFillColor(44, 62, 80);
                pdf.rect(0, 0, pageWidth, 40, 'F');
                pdf.setTextColor(255, 255, 255);
                currentY = addCenteredText('CO√õT DE REVIENT & SUIVI DES MARGES', 20, 20, true);
                currentY = addCenteredText(produitInfo.nom, 14, currentY + 5);
                
                pdf.setTextColor(0, 0, 0);
                currentY = 60;
                
                currentY = addLeftText('Date de l\'analyse: ' + new Date().toLocaleDateString('fr-FR'), 10, margin, currentY);
                currentY = addLeftText('G√©n√©r√© par: ' + currentUser.name + ' (' + currentUser.role + ')', 10, margin, currentY);
                currentY = addLeftText('Prix de vente: ' + produitInfo.prix.toFixed(2) + ' ‚Ç¨', 10, margin, currentY);
                currentY += 10;
                
                const coutMatieres = nomenclatureItems.reduce((total, item) => total + item.coutTotal, 0);
                const coutMainOeuvre = etapesFabrication.reduce((total, etape) => total + (etape.duree / 60) * etape.coutMO, 0);
                const coutFabrication = etapesFabrication.reduce((total, etape) => total + etape.coutMachine, 0);
                const coutTotal = coutMatieres + coutMainOeuvre + coutFabrication;
                const margeBrute = produitInfo.prix - coutTotal;
                const tauxMarge = prixVente > 0 ? (margeBrute / prixVente) * 100 : 0;
                
                pdf.setFillColor(102, 126, 234);
                pdf.rect(margin, currentY, pageWidth - 2*margin, 8, 'F');
                pdf.setTextColor(255, 255, 255);
                currentY = addLeftText('CO√õTS DE REVIENT', 12, margin + 5, currentY + 6, true);
                pdf.setTextColor(0, 0, 0);
                currentY += 5;
                
                const tableData = [
                    ['Mati√®res Premi√®res', coutMatieres.toFixed(2) + ' ‚Ç¨', ((coutMatieres/coutTotal)*100).toFixed(1) + '%'],
                    ['Main d\'≈íuvre', coutMainOeuvre.toFixed(2) + ' ‚Ç¨', ((coutMainOeuvre/coutTotal)*100).toFixed(1) + '%'],
                    ['Frais de Fabrication', coutFabrication.toFixed(2) + ' ‚Ç¨', ((coutFabrication/coutTotal)*100).toFixed(1) + '%'],
                    ['', '', ''],
                    ['CO√õT TOTAL', coutTotal.toFixed(2) + ' ‚Ç¨', '100%']
                ];
                
                pdf.setFillColor(248, 249, 250);
                pdf.rect(margin, currentY, pageWidth - 2*margin, 8, 'F');
                currentY = addLeftText('Poste de co√ªt', 10, margin + 5, currentY + 6, true);
                addLeftText('Montant', 10, margin + 80, currentY - 6, true);
                addLeftText('Pourcentage', 10, margin + 130, currentY - 6, true);
                currentY += 2;
                
                tableData.forEach((row, index) => {
                    const isTotalRow = index === tableData.length - 1;
                    const isEmptyRow = row[0] === '';
                    
                    if (isEmptyRow) {
                        currentY += 3;
                        return;
                    }
                    
                    if (isTotalRow) {
                        pdf.setFillColor(44, 62, 80);
                        pdf.rect(margin, currentY, pageWidth - 2*margin, 8, 'F');
                        pdf.setTextColor(255, 255, 255);
                    }
                    
                    currentY = addLeftText(row[0], 10, margin + 5, currentY + 6, isTotalRow);
                    addLeftText(row[1], 10, margin + 80, currentY - 6, isTotalRow);
                    addLeftText(row[2], 10, margin + 130, currentY - 6, isTotalRow);
                    
                    if (isTotalRow) {
                        pdf.setTextColor(0, 0, 0);
                    }
                    
                    currentY += 2;
                });
                
                currentY += 10;
                
                pdf.setFillColor(40, 167, 69);
                pdf.rect(margin, currentY, pageWidth - 2*margin, 8, 'F');
                pdf.setTextColor(255, 255, 255);
                currentY = addLeftText('ANALYSE DE RENTABILIT√â', 12, margin + 5, currentY + 6, true);
                pdf.setTextColor(0, 0, 0);
                currentY += 8;
                
                currentY = addLeftText('Prix de vente: ' + produitInfo.prix.toFixed(2) + ' ‚Ç¨', 11, margin, currentY, true);
                currentY = addLeftText('Co√ªt de revient: ' + coutTotal.toFixed(2) + ' ‚Ç¨', 11, margin, currentY);
                currentY = addLeftText('Marge brute: ' + margeBrute.toFixed(2) + ' ‚Ç¨', 11, margin, currentY, true);
                currentY = addLeftText('Taux de marge: ' + tauxMarge.toFixed(1) + '%', 11, margin, currentY);
                
                pdf.setFontSize(8);
                pdf.setTextColor(100, 100, 100);
                pdf.text('G√©n√©r√© par l\'outil Co√ªt de revient & Suivi des marges - ' + new Date().toLocaleString('fr-FR'), margin, pageHeight - 10);
                
                const fileName = `Synthese_Cout_Revient_${produitInfo.nom.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
                
                document.getElementById('import-status').innerHTML = 
                    '<div class="alert alert-info">‚úÖ Synth√®se PDF g√©n√©r√©e ! Fichier: ' + fileName + '</div>';
                    
            } catch (error) {
                console.error('Erreur g√©n√©ration PDF:', error);
                document.getElementById('import-status').innerHTML = 
                    '<div class="alert" style="background:#f8d7da;color:#721c24;">‚ùå Erreur lors de la g√©n√©ration PDF: ' + error.message + '</div>';
            }
        }

        // Charger la configuration email sauvegard√©e
        function loadEmailConfig() {
            const savedConfig = localStorage.getItem('emailConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                EMAIL_CONFIG.serviceId = config.serviceId || EMAIL_CONFIG.serviceId;
                EMAIL_CONFIG.templateId = config.templateId || EMAIL_CONFIG.templateId;
                EMAIL_CONFIG.publicKey = config.publicKey || EMAIL_CONFIG.publicKey;
                
                // Mettre √† jour les champs du formulaire
                if (document.getElementById('email_service_id')) {
                    document.getElementById('email_service_id').value = EMAIL_CONFIG.serviceId;
                    document.getElementById('email_template_id').value = EMAIL_CONFIG.templateId;
                    document.getElementById('email_public_key').value = EMAIL_CONFIG.publicKey;
                }
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Charger la configuration email
            loadEmailConfig();
            
            // Initialiser EmailJS
            initEmailJS();
            
            if (!checkSession()) {
                document.getElementById('login-page').style.display = 'block';
                document.getElementById('main-app').style.display = 'none';
            }
            
            updateProduit();
            calculerCouts();
            
            // Charger l'historique des marges au d√©marrage
            mettreAJourHistorique();
        });
    </script>
</body>
</html>